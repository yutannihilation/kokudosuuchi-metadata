Extract data from P26
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `P26`

これは5〜6列目を取り除くだけでよさそう。

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-P26.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                 | 地物名                                                                                                                           | 説明                                                                                                                                                                                                                                                                                                                                  | 説明                                                                                                                                                                                                                                                                                                                                  | 説明                                                                                                                                                                                                                                                                                                                                  | 説明                                                                                                                             |
|:-----------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                 | ニュータウン                                                                                                                     | 都市の過密化への対策として郊外に新たに建設された新しい市街地．                                                                                                                                                                                                                                                                        | 都市の過密化への対策として郊外に新たに建設された新しい市街地．                                                                                                                                                                                                                                                                        | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 属性名（かっこ内はshp属性名）                                                                                                    | 説明                                                                                                                                                                                                                                                                                                                                  | 属性の型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 位置                                                                                                                             | 当該ニュータウンの代表位置．                                                                                                                                                                                                                                                                                                          | 点型（GM\_ Point）                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 都道府県名（P26\_001）                                                                                                           | 各ニュータウンの所在する都道府県名．                                                                                                                                                                                                                                                                                                  | 文字列型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 市区町村名 （P26\_002）                                                                                                          | 各ニュータウンの所在する市町村名．                                                                                                                                                                                                                                                                                                    | 文字列型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 地方公共団体コード〈P26\_003）                                                                                                   | 都道府県コードと市区町村コードからなる，ニュータウンが存在する行政区を特定するためのコード                                                                                                                                                                                                                                            | コードリスト型「行政コード」                                                                                                                                                                                                                                                                                                          | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 地区名 （P26\_004）                                                                                                              | 住宅・宅地開発事業に使用された地区名．                                                                                                                                                                                                                                                                                                | 文字列型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 愛称名 （P26\_005）                                                                                                              | 宅地分譲等が行われた時の愛称等．                                                                                                                                                                                                                                                                                                      | 文字列型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 連たんニュータウン名称 （P26\_006）                                                                                              | 連たんニュータウンの名称                                                                                                                                                                                                                                                                                                              | 文字列型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 施行面積 （P26\_007）                                                                                                            | 事業地区の面積．単位は「ha」．                                                                                                                                                                                                                                                                                                        | 実数型                                                                                                                                                                                                                                                                                                                                | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 事業主体 （P26\_008）                                                                                                            | 各ニュータウンの事業主体の区分．                                                                                                                                                                                                                                                                                                      | 文字列型                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 事業手法 （P26\_009）                                                                                                            | 各ニュータウンの事業手法を特定するためのコード                                                                                                                                                                                                                                                                                        | コードリスト型「事業手法コード」                                                                                                                                                                                                                                                                                                      | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 事業開始年度（西暦） （P26\_010）                                                                                                | 事業開始年度を，事業手法に応じて記載する。                                                                                                                                                                                                                                                                                            | 時間型（TM\_Instant）                                                                                                                                                                                                                                                                                                                 | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 事業終了（予定）年度（西暦） （P26\_011）                                                                                        | 事業終了（予定）年度を，事業手法に応じて記載する。まだ終了していないものの終了年度は，予定年度とする。                                                                                                                                                                                                                                | 時間型（TM\_Instant）                                                                                                                                                                                                                                                                                                                 | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 計画戸数 （P26\_012）                                                                                                            | 事業計画上の計画戸数について，資料等によりデータが確認できる場合に掲載する。単位は「戸」．                                                                                                                                                                                                                                            | 整数型                                                                                                                                                                                                                                                                                                                                | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 計画人口 （P26\_013）                                                                                                            | 事業計画上の計画人口について，資料等によりデータが確認できる場合に掲載する。単位は「人」．                                                                                                                                                                                                                                            | 整数型                                                                                                                                                                                                                                                                                                                                | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 属性情報                                 | 主な品質情報                                                                                                                     | ■完全性/過剰・漏れ：誤率0%原典資料との照合による検査■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証■位置正確度/絶対正確度：誤率0%作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定■主題正確度/定量的主題属性の正しさ・非定量的属性の正しさ：誤率0%原典資料との照合による検査 | ■完全性/過剰・漏れ：誤率0%原典資料との照合による検査■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証■位置正確度/絶対正確度：誤率0%作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定■主題正確度/定量的主題属性の正しさ・非定量的属性の正しさ：誤率0%原典資料との照合による検査 | ■完全性/過剰・漏れ：誤率0%原典資料との照合による検査■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証■位置正確度/絶対正確度：誤率0%作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定■主題正確度/定量的主題属性の正しさ・非定量的属性の正しさ：誤率0%原典資料との照合による検査 | NA                                                                                                                               |
| データフォーマット（符号化）             | ・JPGISに準拠した符号化（GML形式）．詳細は製品仕様書内の符号化規則を参照してください．・シェープファイル形式．                   | ・JPGISに準拠した符号化（GML形式）．詳細は製品仕様書内の符号化規則を参照してください．・シェープファイル形式．                                                                                                                                                                                                                        | ・JPGISに準拠した符号化（GML形式）．詳細は製品仕様書内の符号化規則を参照してください．・シェープファイル形式．                                                                                                                                                                                                                        | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 国土情報ウェブマッピングシステムへの登録 | 登録なし                                                                                                                         | 登録なし                                                                                                                                                                                                                                                                                                                              | 登録なし                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                                                                                                                                    | NA                                                                                                                               |
| 識別子                                   | P26                                                                                                                              | P26                                                                                                                                                                                                                                                                                                                                   | P26                                                                                                                                                                                                                                                                                                                                   | P26                                                                                                                                                                                                                                                                                                                                   | P26                                                                                                                              |
| その他の情報                             | ・原典資料として、基本的に全国のニュータウンリストを利用していますが、問い合わせで実状を確認できた場合、内容修正を行っています． | ・原典資料として、基本的に全国のニュータウンリストを利用していますが、問い合わせで実状を確認できた場合、内容修正を行っています．                                                                                                                                                                                                      | ・原典資料として、基本的に全国のニュータウンリストを利用していますが、問い合わせで実状を確認できた場合、内容修正を行っています．                                                                                                                                                                                                      | ・原典資料として、基本的に全国のニュータウンリストを利用していますが、問い合わせで実状を確認できた場合、内容修正を行っています．                                                                                                                                                                                                      | ・原典資料として、基本的に全国のニュータウンリストを利用していますが、問い合わせで実状を確認できた場合、内容修正を行っています． |

``` r
attr_table <- attr_table %>% 
  # 重複を取り除くため
  tibble::as_tibble(.name_repair = "unique") %>% 
  select(1:4)
```

    ## New names:
    ## * 説明 -> 説明...3
    ## * 説明 -> 説明...4
    ## * 説明 -> 説明...5
    ## * 説明 -> 説明...6

``` r
colnames(attr_table) <- c("_", "name", "description", "type")

attr_table <- attr_table %>% 
  filter(
    `_` == "属性情報",
    # テーブルのヘッダは取り除く
    !startsWith(name, "属性名"),
    !startsWith(name, "地物名"),
    type != "説明",
    # 地物は属性情報ではない
    !stringr::str_detect(stringr::str_remove_all(type, "\\s+"), "^(曲面型|曲線型|点型|GM_Surface|GM_Curve|GM_Point)")
  )

res <- attr_table %>%
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)([（〈][A-Za-z0-9]+_[A-Za-z0-9]+）)?$") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（〈）]"), NA_character_),
    description,
    type
  )
```

最後の行もいらなそうなので消しておく

``` r
knitr::kable(res)
```

| name                         | code     | description                                                                                                                                                                                                                                                                                                                           | type                                                                                                                                                                                                                                                                                                                                  |
|:-----------------------------|:---------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 都道府県名                   | P26\_001 | 各ニュータウンの所在する都道府県名．                                                                                                                                                                                                                                                                                                  | 文字列型                                                                                                                                                                                                                                                                                                                              |
| 市区町村名                   | P26\_002 | 各ニュータウンの所在する市町村名．                                                                                                                                                                                                                                                                                                    | 文字列型                                                                                                                                                                                                                                                                                                                              |
| 地方公共団体コード           | P26\_003 | 都道府県コードと市区町村コードからなる，ニュータウンが存在する行政区を特定するためのコード                                                                                                                                                                                                                                            | コードリスト型「行政コード」                                                                                                                                                                                                                                                                                                          |
| 地区名                       | P26\_004 | 住宅・宅地開発事業に使用された地区名．                                                                                                                                                                                                                                                                                                | 文字列型                                                                                                                                                                                                                                                                                                                              |
| 愛称名                       | P26\_005 | 宅地分譲等が行われた時の愛称等．                                                                                                                                                                                                                                                                                                      | 文字列型                                                                                                                                                                                                                                                                                                                              |
| 連たんニュータウン名称       | P26\_006 | 連たんニュータウンの名称                                                                                                                                                                                                                                                                                                              | 文字列型                                                                                                                                                                                                                                                                                                                              |
| 施行面積                     | P26\_007 | 事業地区の面積．単位は「ha」．                                                                                                                                                                                                                                                                                                        | 実数型                                                                                                                                                                                                                                                                                                                                |
| 事業主体                     | P26\_008 | 各ニュータウンの事業主体の区分．                                                                                                                                                                                                                                                                                                      | 文字列型                                                                                                                                                                                                                                                                                                                              |
| 事業手法                     | P26\_009 | 各ニュータウンの事業手法を特定するためのコード                                                                                                                                                                                                                                                                                        | コードリスト型「事業手法コード」                                                                                                                                                                                                                                                                                                      |
| 事業開始年度（西暦）         | P26\_010 | 事業開始年度を，事業手法に応じて記載する。                                                                                                                                                                                                                                                                                            | 時間型（TM\_Instant）                                                                                                                                                                                                                                                                                                                 |
| 事業終了（予定）年度（西暦） | P26\_011 | 事業終了（予定）年度を，事業手法に応じて記載する。まだ終了していないものの終了年度は，予定年度とする。                                                                                                                                                                                                                                | 時間型（TM\_Instant）                                                                                                                                                                                                                                                                                                                 |
| 計画戸数                     | P26\_012 | 事業計画上の計画戸数について，資料等によりデータが確認できる場合に掲載する。単位は「戸」．                                                                                                                                                                                                                                            | 整数型                                                                                                                                                                                                                                                                                                                                |
| 計画人口                     | P26\_013 | 事業計画上の計画人口について，資料等によりデータが確認できる場合に掲載する。単位は「人」．                                                                                                                                                                                                                                            | 整数型                                                                                                                                                                                                                                                                                                                                |
| 主な品質情報                 | NA       | ■完全性/過剰・漏れ：誤率0%原典資料との照合による検査■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証■位置正確度/絶対正確度：誤率0%作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定■主題正確度/定量的主題属性の正しさ・非定量的属性の正しさ：誤率0%原典資料との照合による検査 | ■完全性/過剰・漏れ：誤率0%原典資料との照合による検査■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証■位置正確度/絶対正確度：誤率0%作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定■主題正確度/定量的主題属性の正しさ・非定量的属性の正しさ：誤率0%原典資料との照合による検査 |

``` r
res %>% 
  slice(-n()) %>% 
  readr::write_csv(output)
```
