Extract data from P20
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `P20`

これは災害分類を手動でなんとかする必要がある。

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-P20.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                 | 地物名                                                                                                                                                                                                                                                                                                                                                                                       | 説明                                                                                                                                                                                                                                                                                                                                                                                         | 説明                                                                                                                                                                                                                                                                                                                                                                                         | 説明                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                          |
|:-----------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                 | 避難施設                                                                                                                                                                                                                                                                                                                                                                                     | 自然災害発生時に住民を避難させ、又は避難住民等の救援を行うための施設で、市町村長が指定し地域防災計画等に掲載されている施設                                                                                                                                                                                                                                                                   | 自然災害発生時に住民を避難させ、又は避難住民等の救援を行うための施設で、市町村長が指定し地域防災計画等に掲載されている施設                                                                                                                                                                                                                                                                   | 自然災害発生時に住民を避難させ、又は避難住民等の救援を行うための施設で、市町村長が指定し地域防災計画等に掲載されている施設                                                                                                                                                                                                                                                                   | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 属性名（かっこ内はshp属性）                                                                                                                                                                                                                                                                                                                                                                  | 説明                                                                                                                                                                                                                                                                                                                                                                                         | 説明                                                                                                                                                                                                                                                                                                                                                                                         | 属性の型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 位置                                                                                                                                                                                                                                                                                                                                                                                         | 避難施設の位置                                                                                                                                                                                                                                                                                                                                                                               | 避難施設の位置                                                                                                                                                                                                                                                                                                                                                                               | GM\_ Point                                                                                                                                                                                                                                                                                                                                                                                   | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 行政区域（P20\_001）                                                                                                                                                                                                                                                                                                                                                                         | 都道府県コードと市区町村コードからなる，避難施設の所在する行政区を特定するためのコード                                                                                                                                                                                                                                                                                                       | 都道府県コードと市区町村コードからなる，避難施設の所在する行政区を特定するためのコード                                                                                                                                                                                                                                                                                                       | コードリスト型（行政区域コード）                                                                                                                                                                                                                                                                                                                                                             | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 名称（P20\_002）                                                                                                                                                                                                                                                                                                                                                                             | 避難施設の名称                                                                                                                                                                                                                                                                                                                                                                               | 避難施設の名称                                                                                                                                                                                                                                                                                                                                                                               | 文字列型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 住所（P20\_003）                                                                                                                                                                                                                                                                                                                                                                             | 避難施設の住所                                                                                                                                                                                                                                                                                                                                                                               | 避難施設の住所                                                                                                                                                                                                                                                                                                                                                                               | 文字列型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 施設の種類（P20\_004）                                                                                                                                                                                                                                                                                                                                                                       | 避難施設の種類                                                                                                                                                                                                                                                                                                                                                                               | 避難施設の種類                                                                                                                                                                                                                                                                                                                                                                               | 文字列型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 収容人数（P20\_005）                                                                                                                                                                                                                                                                                                                                                                         | 避難施設の形態ごとの収容可能人数                                                                                                                                                                                                                                                                                                                                                             | 避難施設の形態ごとの収容可能人数                                                                                                                                                                                                                                                                                                                                                             | 整数値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 施設規模（P20\_006）                                                                                                                                                                                                                                                                                                                                                                         | 避難施設の形態ごとの面積（単位は平方メートル）                                                                                                                                                                                                                                                                                                                                               | 避難施設の形態ごとの面積（単位は平方メートル）                                                                                                                                                                                                                                                                                                                                               | 文字列型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     | 当該施設が対象とする災害の分類                                                                                                                                                                                                                                                                                                                                                               | 当該施設が対象とする災害の分類                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                              | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                              | 地震災害（P20\_007）                                                                                                                                                                                                                                                                                                                                                                         | 真偽値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                              | 津波災害（P20\_008）                                                                                                                                                                                                                                                                                                                                                                         | 真偽値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                              | 水害（P20\_009）                                                                                                                                                                                                                                                                                                                                                                             | 真偽値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                              | 火山災害（P20\_010）                                                                                                                                                                                                                                                                                                                                                                         | 真偽値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                              | その他（P20\_011）                                                                                                                                                                                                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | 災害分類                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                              | 指定なし（P20\_012）                                                                                                                                                                                                                                                                                                                                                                         | 真偽値型                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 属性情報                                 | レベル：位置について原典資料との一致を表します。                                                                                                                                                                                                                                                                                                                                             | ・レベル１：国土数値情報と位置が一致・レベル２：GISデータが整備されている自治体の施設と位置が一致・レベル３：防災マップ、ハザードマップ又はWEB地図と位置が一致・レベル４：国土数値情報と位置が異なりレベル３と位置が一致                                                                                                                                                                     | ・レベル１：国土数値情報と位置が一致・レベル２：GISデータが整備されている自治体の施設と位置が一致・レベル３：防災マップ、ハザードマップ又はWEB地図と位置が一致・レベル４：国土数値情報と位置が異なりレベル３と位置が一致                                                                                                                                                                     | ・レベル１：国土数値情報と位置が一致・レベル２：GISデータが整備されている自治体の施設と位置が一致・レベル３：防災マップ、ハザードマップ又はWEB地図と位置が一致・レベル４：国土数値情報と位置が異なりレベル３と位置が一致                                                                                                                                                                     | ・レベル１：国土数値情報と位置が一致・レベル２：GISデータが整備されている自治体の施設と位置が一致・レベル３：防災マップ、ハザードマップ又はWEB地図と位置が一致・レベル４：国土数値情報と位置が異なりレベル３と位置が一致 |
| 主な品質情報                             | ・完全性/過剰・漏れ：誤率0%原典資料との照合による検査・論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証・主題正確度/非定量的属性の正しさ：誤率0%原典資料との照合による検査・位置正確度/絶対正確度：実寸25ｍ作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定                                                                          | ・完全性/過剰・漏れ：誤率0%原典資料との照合による検査・論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証・主題正確度/非定量的属性の正しさ：誤率0%原典資料との照合による検査・位置正確度/絶対正確度：実寸25ｍ作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定                                                                          | ・完全性/過剰・漏れ：誤率0%原典資料との照合による検査・論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証・主題正確度/非定量的属性の正しさ：誤率0%原典資料との照合による検査・位置正確度/絶対正確度：実寸25ｍ作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定                                                                          | ・完全性/過剰・漏れ：誤率0%原典資料との照合による検査・論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証・主題正確度/非定量的属性の正しさ：誤率0%原典資料との照合による検査・位置正確度/絶対正確度：実寸25ｍ作成データ（地物）と原典資料を重ねて表示し位置のズレの最大値を測定                                                                          | NA                                                                                                                                                                                                                       |
| データフォーマット（符号化）             | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。                                                                                                                                                                                                                                                                                          | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。                                                                                                                                                                                                                                                                                          | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。                                                                                                                                                                                                                                                                                          | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。                                                                                                                                                                                                                                                                                          | NA                                                                                                                                                                                                                       |
| 国土情報ウェブマッピングシステムへの登録 | 登録なし                                                                                                                                                                                                                                                                                                                                                                                     | 登録なし                                                                                                                                                                                                                                                                                                                                                                                     | 登録なし                                                                                                                                                                                                                                                                                                                                                                                     | 登録なし                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                       |
| 識別子                                   | P20                                                                                                                                                                                                                                                                                                                                                                                          | P20                                                                                                                                                                                                                                                                                                                                                                                          | P20                                                                                                                                                                                                                                                                                                                                                                                          | P20                                                                                                                                                                                                                                                                                                                                                                                          | NA                                                                                                                                                                                                                       |
| その他の情報                             | ・本データは、最新の情報ではない場合もあることから、災害時に避難施設を利用する際は、各地方公共団体が公開している最新の情報を確認してください。・本データは、原則として地方公共団体の地域防災計画に記載された避難所リストを参考にしています。ただし、地方公共団体によっては、他の情報源から整備しているものもあり、地方公共団体ごとの避難施設データの整備基準が異なりますので、注意ください。 | ・本データは、最新の情報ではない場合もあることから、災害時に避難施設を利用する際は、各地方公共団体が公開している最新の情報を確認してください。・本データは、原則として地方公共団体の地域防災計画に記載された避難所リストを参考にしています。ただし、地方公共団体によっては、他の情報源から整備しているものもあり、地方公共団体ごとの避難施設データの整備基準が異なりますので、注意ください。 | ・本データは、最新の情報ではない場合もあることから、災害時に避難施設を利用する際は、各地方公共団体が公開している最新の情報を確認してください。・本データは、原則として地方公共団体の地域防災計画に記載された避難所リストを参考にしています。ただし、地方公共団体によっては、他の情報源から整備しているものもあり、地方公共団体ごとの避難施設データの整備基準が異なりますので、注意ください。 | ・本データは、最新の情報ではない場合もあることから、災害時に避難施設を利用する際は、各地方公共団体が公開している最新の情報を確認してください。・本データは、原則として地方公共団体の地域防災計画に記載された避難所リストを参考にしています。ただし、地方公共団体によっては、他の情報源から整備しているものもあり、地方公共団体ごとの避難施設データの整備基準が異なりますので、注意ください。 | NA                                                                                                                                                                                                                       |

``` r
attr_table <- attr_table %>% 
  # 重複を取り除くため
  tibble::as_tibble(.name_repair = "unique") %>% 
  select(-6)
```

    ## New names:
    ## * 説明 -> 説明...3
    ## * 説明 -> 説明...4
    ## * 説明 -> 説明...5
    ## * `` -> ...6

``` r
colnames(attr_table) <- c("_", "name", "description", "description2", "type")

attr_table <- attr_table %>% 
  filter(
    `_` == "属性情報",
    # テーブルのヘッダは取り除く
    !startsWith(name, "属性名"),
    !startsWith(name, "地物名"),
    type != "説明",
    # 地物は属性情報ではない
    !stringr::str_detect(stringr::str_remove_all(type, "\\s+"), "^(曲面型|曲線型|点型|GM_Surface|GM_Curve|GM_Point)")
  )

res <- attr_table %>%
  mutate(
    name = if_else(name == "災害分類", paste(name, description2, sep = "_"), name),
    description = na_if(description, ""),
    .keep = "unused"
  ) %>% 
  # 災害分類の部分は下向きに fill する
  tidyr::fill(description) %>% 
  # 終わったら不要なので消す
  filter(type != "") %>% 
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)(（[A-Za-z0-9]+_[A-Za-z0-9]+）)?$") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（）]"), NA_character_),
    description,
    type
  )
```

最後の行もいらなそうなので消しておく

``` r
knitr::kable(res)
```

| name                                             | code     | description                                                                                                                                                                                                              | type                                                                                                                                                                                                                     |
|:-------------------------------------------------|:---------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 行政区域                                         | P20\_001 | 都道府県コードと市区町村コードからなる，避難施設の所在する行政区を特定するためのコード                                                                                                                                   | コードリスト型（行政区域コード）                                                                                                                                                                                         |
| 名称                                             | P20\_002 | 避難施設の名称                                                                                                                                                                                                           | 文字列型                                                                                                                                                                                                                 |
| 住所                                             | P20\_003 | 避難施設の住所                                                                                                                                                                                                           | 文字列型                                                                                                                                                                                                                 |
| 施設の種類                                       | P20\_004 | 避難施設の種類                                                                                                                                                                                                           | 文字列型                                                                                                                                                                                                                 |
| 収容人数                                         | P20\_005 | 避難施設の形態ごとの収容可能人数                                                                                                                                                                                         | 整数値型                                                                                                                                                                                                                 |
| 施設規模                                         | P20\_006 | 避難施設の形態ごとの面積（単位は平方メートル）                                                                                                                                                                           | 文字列型                                                                                                                                                                                                                 |
| 災害分類\_地震災害                               | P20\_007 | 当該施設が対象とする災害の分類                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                 |
| 災害分類\_津波災害                               | P20\_008 | 当該施設が対象とする災害の分類                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                 |
| 災害分類\_水害                                   | P20\_009 | 当該施設が対象とする災害の分類                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                 |
| 災害分類\_火山災害                               | P20\_010 | 当該施設が対象とする災害の分類                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                 |
| 災害分類\_その他                                 | P20\_011 | 当該施設が対象とする災害の分類                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                 |
| 災害分類\_指定なし                               | P20\_012 | 当該施設が対象とする災害の分類                                                                                                                                                                                           | 真偽値型                                                                                                                                                                                                                 |
| レベル：位置について原典資料との一致を表します。 | NA       | ・レベル１：国土数値情報と位置が一致・レベル２：GISデータが整備されている自治体の施設と位置が一致・レベル３：防災マップ、ハザードマップ又はWEB地図と位置が一致・レベル４：国土数値情報と位置が異なりレベル３と位置が一致 | ・レベル１：国土数値情報と位置が一致・レベル２：GISデータが整備されている自治体の施設と位置が一致・レベル３：防災マップ、ハザードマップ又はWEB地図と位置が一致・レベル４：国土数値情報と位置が異なりレベル３と位置が一致 |

``` r
res %>% 
  slice(-n()) %>% 
  readr::write_csv(output)
```
