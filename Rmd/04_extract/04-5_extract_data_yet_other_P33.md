Extract data from P33
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `P33`

代表点区分のコードが抜けているが、どうも実データを見る感じ`P33_041`らしい。

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-P33.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                 | 地物名                                                                                                                                                                                                                                 | 説明                                                                                                                                                                                                                                   | 形状                                                                                                                                                                                                                                   |
|:-----------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                 | 集客施設（P33-14 XX）XX:都道府県コード                                                                                                                                                                                                 | 集客施設が存在する地点                                                                                                                                                                                                                 | 点型（GM\_Point）                                                                                                                                                                                                                      |
| 地物情報                                 | 属性名（かっこ内はシェープファイルの属性名）                                                                                                                                                                                           | 説明                                                                                                                                                                                                                                   | 属性の型                                                                                                                                                                                                                               |
| 地物情報                                 | 施設ID（P33\_001）※施設IDはシェープファイルのみ                                                                                                                                                                                        | 集客施設ごとの整理番号                                                                                                                                                                                                                 | 整数型（Integer）                                                                                                                                                                                                                      |
| 地物情報                                 | 行政コード（P33\_002）                                                                                                                                                                                                                 | 集客施設が属する市区町村の市区町村を示す、都道府県コードと市区町村コードからなるコ－ドJSI規格（JIS X 0401,　JIS X 0402）準拠                                                                                                           | コードリスト「行政コード」                                                                                                                                                                                                             |
| 地物情報                                 | 都道府県コード（P33\_003）                                                                                                                                                                                                             | 集客施設が属する都道府県の都道府県コ－ドJSI規格（JIS X 0401,　JIS X 0402）準拠                                                                                                                                                         | コードリスト「都道府県コード」                                                                                                                                                                                                         |
| 地物情報                                 | 施設区分コード（P33\_004）                                                                                                                                                                                                             | 施設用途による区分                                                                                                                                                                                                                     | コードリスト「施設区分コード」                                                                                                                                                                                                         |
| 地物情報                                 | 施設名称（P33\_005）                                                                                                                                                                                                                   | 施設名および施設の名称                                                                                                                                                                                                                 | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 郵便番号（P33\_006）                                                                                                                                                                                                                   | 当該施設の番号                                                                                                                                                                                                                         | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 住所・所在地（P33\_007）                                                                                                                                                                                                               | 当該施設の所在地                                                                                                                                                                                                                       | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 電話番号（P33\_008）                                                                                                                                                                                                                   | 当該施設の電話番号                                                                                                                                                                                                                     | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 開設年月日（P33\_009）                                                                                                                                                                                                                 | 当該施設の開館（開業）の年月日（YYYYMMDd〉                                                                                                                                                                                             | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | ホームページURL（P33\_010）                                                                                                                                                                                                            | 当該施設のウェブページURL                                                                                                                                                                                                              | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | アクセス（P33\_011）                                                                                                                                                                                                                   | 当該施設までの交通機関によるアクセス方法                                                                                                                                                                                               | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | スクリーン数（P33\_012）                                                                                                                                                                                                               | 当該施設が映画館の場合の、そのスクリーン数                                                                                                                                                                                             | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | 総席数（P33\_013）                                                                                                                                                                                                                     | 当該施設が映画館の場合の、その座席数                                                                                                                                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | 公民館の種別（P33\_014）                                                                                                                                                                                                               | 公民館の区分                                                                                                                                                                                                                           | コードリスト「公民館の種別コード」※公民館以外の施設の場合、「-1」とする。                                                                                                                                                              |
| 地物情報                                 | 営業・稼働日数（P33\_015）                                                                                                                                                                                                             | 当該施設の営業日・稼働日数                                                                                                                                                                                                             | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 営業時間（P33\_016）                                                                                                                                                                                                                   | 当該施設の営業時間                                                                                                                                                                                                                     | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 入場料の有無（P33\_017）                                                                                                                                                                                                               | レジャー施設の入場料金（有料、無料）の区分                                                                                                                                                                                             | 文字列型（CharacterString）                                                                                                                                                                                                            |
| 地物情報                                 | 敷地面積（P33\_018）                                                                                                                                                                                                                   | 当該施設の敷地面積（平方メートル）                                                                                                                                                                                                     | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | 建築総面積（P33\_019）                                                                                                                                                                                                                 | 当該施設の建築総面積（平方メートル）                                                                                                                                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | ホール数（P33\_020）                                                                                                                                                                                                                   | 当該施設が有するホールの数                                                                                                                                                                                                             | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | ホールの最大席数（P33\_021）                                                                                                                                                                                                           | 当該施設が有する最大のホールの座席数                                                                                                                                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | ホールの総席数（P33\_022）                                                                                                                                                                                                             | 当該施設が有するホールの座席の合計                                                                                                                                                                                                     | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | 会議室数（P33\_023）                                                                                                                                                                                                                   | 当該施設が有する会議室の数                                                                                                                                                                                                             | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | 展示室数（P33\_024）                                                                                                                                                                                                                   | 当該施設が有する展示室の数                                                                                                                                                                                                             | 整数型（Integer）※整備データが存在しない場合、「-1」とする。                                                                                                                                                                           |
| 地物情報                                 | 代表点区分                                                                                                                                                                                                                             | データの位置情報精度で区分したコード                                                                                                                                                                                                   | コードリスト「代表点区分コード」                                                                                                                                                                                                       |
| ※施設IDはシェープファイルのみ            | ※施設IDはシェープファイルのみ                                                                                                                                                                                                          | ※施設IDはシェープファイルのみ                                                                                                                                                                                                          | ※施設IDはシェープファイルのみ                                                                                                                                                                                                          |
| 主な品質情報                             | ■ 完全性/過剰・漏れ：　過剰・漏れデータ数　全数検査0個■ 論理一貫性/書式一貫性・概念一貫性・定義域一貫性：　全数検査　誤率0%■ 位置正確度/絶対正確度：　全数検査　図上0.3mm以内■ 主題正確度/非定量的主題属性の正しさ：　全数検査　誤率0% | ■ 完全性/過剰・漏れ：　過剰・漏れデータ数　全数検査0個■ 論理一貫性/書式一貫性・概念一貫性・定義域一貫性：　全数検査　誤率0%■ 位置正確度/絶対正確度：　全数検査　図上0.3mm以内■ 主題正確度/非定量的主題属性の正しさ：　全数検査　誤率0% | ■ 完全性/過剰・漏れ：　過剰・漏れデータ数　全数検査0個■ 論理一貫性/書式一貫性・概念一貫性・定義域一貫性：　全数検査　誤率0%■ 位置正確度/絶対正確度：　全数検査　図上0.3mm以内■ 主題正確度/非定量的主題属性の正しさ：　全数検査　誤率0% |
| データフォーマット（符号化）             | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。                                                                                                                                  | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。                                                                                                                                  | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。                                                                                                                                  |
| 国土情報ウェブマッピングシステムへの登録 | 登録なし                                                                                                                                                                                                                               | 登録なし                                                                                                                                                                                                                               | 登録なし                                                                                                                                                                                                                               |
| その他                                   |                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                        |
| 識別子                                   | P33                                                                                                                                                                                                                                    | P33                                                                                                                                                                                                                                    | P33                                                                                                                                                                                                                                    |
| その他の情報                             | ・各データのメタデータについては、ダウンロードしたファイルに添付されています。・本データは有償刊行物を使用し作成したものですので商用利用はできません。                                                                                 | ・各データのメタデータについては、ダウンロードしたファイルに添付されています。・本データは有償刊行物を使用し作成したものですので商用利用はできません。                                                                                 | ・各データのメタデータについては、ダウンロードしたファイルに添付されています。・本データは有償刊行物を使用し作成したものですので商用利用はできません。                                                                                 |

``` r
colnames(attr_table) <- c("_", "name", "description", "type")

attr_table <- attr_table %>% 
  filter(
    # 名前が違う
    `_` == "地物情報",
    # テーブルのヘッダは取り除く
    !startsWith(name, "属性名"),
    !startsWith(name, "地物名"),
    type != "説明",
    # 地物は属性情報ではない
    !stringr::str_detect(stringr::str_remove_all(type, "\\s+"), "^(曲面型|曲線型|点型|GM_Surface|GM_Curve|GM_Point)")
  )

res <- attr_table %>%
  # 代表点区分はextractできないので残しておく
  mutate(name_orig = name) %>% 
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)(（[A-Za-z0-9]+_[A-Za-z0-9]+）)") %>% 
  transmute(
    name = coalesce(name, name_orig),
    code = case_when(
      name_orig == "代表点区分" ~ "P33_041",
      code != '' ~ stringr::str_remove_all(code, "[（）]")
    ),
    description,
    type
  ) %>% 
  filter(!is.na(code))
```

``` r
knitr::kable(res)
```

| name             | code     | description                                                                                                                  | type                                                                      |
|:-----------------|:---------|:-----------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------|
| 施設ID           | P33\_001 | 集客施設ごとの整理番号                                                                                                       | 整数型（Integer）                                                         |
| 行政コード       | P33\_002 | 集客施設が属する市区町村の市区町村を示す、都道府県コードと市区町村コードからなるコ－ドJSI規格（JIS X 0401,　JIS X 0402）準拠 | コードリスト「行政コード」                                                |
| 都道府県コード   | P33\_003 | 集客施設が属する都道府県の都道府県コ－ドJSI規格（JIS X 0401,　JIS X 0402）準拠                                               | コードリスト「都道府県コード」                                            |
| 施設区分コード   | P33\_004 | 施設用途による区分                                                                                                           | コードリスト「施設区分コード」                                            |
| 施設名称         | P33\_005 | 施設名および施設の名称                                                                                                       | 文字列型（CharacterString）                                               |
| 郵便番号         | P33\_006 | 当該施設の番号                                                                                                               | 文字列型（CharacterString）                                               |
| 住所・所在地     | P33\_007 | 当該施設の所在地                                                                                                             | 文字列型（CharacterString）                                               |
| 電話番号         | P33\_008 | 当該施設の電話番号                                                                                                           | 文字列型（CharacterString）                                               |
| 開設年月日       | P33\_009 | 当該施設の開館（開業）の年月日（YYYYMMDd〉                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| ホームページURL  | P33\_010 | 当該施設のウェブページURL                                                                                                    | 文字列型（CharacterString）                                               |
| アクセス         | P33\_011 | 当該施設までの交通機関によるアクセス方法                                                                                     | 文字列型（CharacterString）                                               |
| スクリーン数     | P33\_012 | 当該施設が映画館の場合の、そのスクリーン数                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| 総席数           | P33\_013 | 当該施設が映画館の場合の、その座席数                                                                                         | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| 公民館の種別     | P33\_014 | 公民館の区分                                                                                                                 | コードリスト「公民館の種別コード」※公民館以外の施設の場合、「-1」とする。 |
| 営業・稼働日数   | P33\_015 | 当該施設の営業日・稼働日数                                                                                                   | 文字列型（CharacterString）                                               |
| 営業時間         | P33\_016 | 当該施設の営業時間                                                                                                           | 文字列型（CharacterString）                                               |
| 入場料の有無     | P33\_017 | レジャー施設の入場料金（有料、無料）の区分                                                                                   | 文字列型（CharacterString）                                               |
| 敷地面積         | P33\_018 | 当該施設の敷地面積（平方メートル）                                                                                           | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| 建築総面積       | P33\_019 | 当該施設の建築総面積（平方メートル）                                                                                         | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| ホール数         | P33\_020 | 当該施設が有するホールの数                                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| ホールの最大席数 | P33\_021 | 当該施設が有する最大のホールの座席数                                                                                         | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| ホールの総席数   | P33\_022 | 当該施設が有するホールの座席の合計                                                                                           | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| 会議室数         | P33\_023 | 当該施設が有する会議室の数                                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| 展示室数         | P33\_024 | 当該施設が有する展示室の数                                                                                                   | 整数型（Integer）※整備データが存在しない場合、「-1」とする。              |
| 代表点区分       | P33\_041 | データの位置情報精度で区分したコード                                                                                         | コードリスト「代表点区分コード」                                          |

``` r
res %>% 
  readr::write_csv(output)
```
