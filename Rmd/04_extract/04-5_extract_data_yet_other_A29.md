Extract data from A29
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `A29`

これはテーブルをコメントアウトしたあとに `rowspan`
を直すの忘れてるっぽい。ここが`10`のはず

``` html
<tr>
    <th rowspan="12">属性情報</th>
    <th>属性名（かっこ内はshp属性名）</th>
    <th>説明</th>
    <th>属性の型</th>
</tr>
```

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-A29-v2_1.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

input_text <- brio::read_file(input) %>% 
  stringr::str_replace('rowspan="12"', 'rowspan="10"')

attr_table <- read_html(input_text) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                                                 | 地物名                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 説明                                                                                                                                                                                                                                                           | 説明                                                                                                                                                                                                                                                           |
|:-------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                                                 | 用途地域                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 用途地域は、都市計画法に基づく地域地区（都市計画法第八条）として、住居、商業、工業など市街地の大枠としての土地利用を定めるもので、用途別に分類される１３種類の用途地域の集合で構成される。                                                                     | 用途地域は、都市計画法に基づく地域地区（都市計画法第八条）として、住居、商業、工業など市街地の大枠としての土地利用を定めるもので、用途別に分類される１３種類の用途地域の集合で構成される。                                                                     |
| 属性情報                                                                 | 属性名（かっこ内はshp属性名）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 説明                                                                                                                                                                                                                                                           | 属性の型                                                                                                                                                                                                                                                       |
| 属性情報                                                                 | 範囲                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 用途地域として参照図（都市計画総括図など）に記載された地域の範囲                                                                                                                                                                                               | 曲面型（GM\_Surface）                                                                                                                                                                                                                                          |
| 属性情報                                                                 | 行政区域コード（A29\_001）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 用途地域がある市区町村の行政コード                                                                                                                                                                                                                             | コードリスト「行政コード」                                                                                                                                                                                                                                     |
| 属性情報                                                                 | 都道府県名（A29\_002）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 用途地域がある都道府県の名称                                                                                                                                                                                                                                   | 文字列型（CharacterString）                                                                                                                                                                                                                                    |
| 属性情報                                                                 | 市区町村名（A29\_003）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 用途地域がある市区町村の名称                                                                                                                                                                                                                                   | 文字列型（CharacterString）                                                                                                                                                                                                                                    |
| 属性情報                                                                 | 用途地域コード（A29\_004）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 用途地域分類コード                                                                                                                                                                                                                                             | コードリスト「用途地域分類コード」                                                                                                                                                                                                                             |
| 属性情報                                                                 | 用途地域名（A29\_005）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 用途地域の種類の名称                                                                                                                                                                                                                                           | 文字列型（CharacterString）                                                                                                                                                                                                                                    |
| 属性情報                                                                 | 建蔽率（A29\_006）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 用途地域及び指定地域別の建蔽率（%）。不明の時は’9999’とする                                                                                                                                                                                                    | 整数型（Decimal）                                                                                                                                                                                                                                              |
| 属性情報                                                                 | 容積率（A29\_007）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 用途地域及び指定地域別の容積率（%）。不明の時は’9999’とする                                                                                                                                                                                                    | 整数型（Decimal）                                                                                                                                                                                                                                              |
| 属性情報                                                                 | 備考（A29\_008）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 用途地域に関する備考                                                                                                                                                                                                                                           | 文字列型（CharacterString）                                                                                                                                                                                                                                    |
| 主な品質情報                                                             | ■完全性/過剰・漏れ： 原典資料との比較による全数検査、誤率0%■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：XMLスキーマに対する妥当性を検証　誤率0％■位置正確度/絶対正確度（外部正確度）：原典資料の縮尺で重ねて表示し位置のズレの最大値を測定　図上0.3mm以内                                                                                                                                                                                                                                                                                                          | ■完全性/過剰・漏れ： 原典資料との比較による全数検査、誤率0%■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：XMLスキーマに対する妥当性を検証　誤率0％■位置正確度/絶対正確度（外部正確度）：原典資料の縮尺で重ねて表示し位置のズレの最大値を測定　図上0.3mm以内 | ■完全性/過剰・漏れ： 原典資料との比較による全数検査、誤率0%■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：XMLスキーマに対する妥当性を検証　誤率0％■位置正確度/絶対正確度（外部正確度）：原典資料の縮尺で重ねて表示し位置のズレの最大値を測定　図上0.3mm以内 |
| データフォーマット（符号化）                                             | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。（平成23年度版）                                                                                                                                                                                                                                                                                                                                                                                                                                          | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。（平成23年度版）                                                                                                                                 | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。（平成23年度版）                                                                                                                                 |
| 国土情報ウェブマッピングシステムへの登録                                 | 調整中                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 調整中                                                                                                                                                                                                                                                         | 調整中                                                                                                                                                                                                                                                         |
| 識別子                                                                   | A29                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | A29                                                                                                                                                                                                                                                            | A29                                                                                                                                                                                                                                                            |
| その他の情報                                                             | ・メタデータについては、ダウンロードした都道府県ファイルに添付されています。・本データは、縮尺1/2,500の都市計画図をデータ化したものではなく、縮尺1／10,000～1／50,000の都市計画総括図等をデータ化したものであり、 誤差を含んでいますので、精緻な作業には使用しないでください。また、国土数値情報ダウンロードサイトコンテンツ利用規約に従い、免責事項・地図の精度に起因する誤差を含むことについて、最終的な利用者まで伝達してください。 ・本データの利用により生じた利用者の損失・損害については、国土交通省ならびに原典資料提供元の各市区町村は一切の責任を負いません。 |                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                |
| ・詳細な情報及び公開条件については各市区町村に必ずお問い合わせください。 | ・メタデータについては、ダウンロードした都道府県ファイルに添付されています。・本データは、縮尺1/2,500の都市計画図をデータ化したものではなく、縮尺1／10,000～1／50,000の都市計画総括図等をデータ化したものであり、 誤差を含んでいますので、精緻な作業には使用しないでください。また、国土数値情報ダウンロードサイトコンテンツ利用規約に従い、免責事項・地図の精度に起因する誤差を含むことについて、最終的な利用者まで伝達してください。 ・本データの利用により生じた利用者の損失・損害については、国土交通省ならびに原典資料提供元の各市区町村は一切の責任を負いません。 |                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                |
| ・詳細な情報及び公開条件については各市区町村に必ずお問い合わせください。 | ・メタデータについては、ダウンロードした都道府県ファイルに添付されています。・本データは、縮尺1/2,500の都市計画図をデータ化したものではなく、縮尺1／10,000～1／50,000の都市計画総括図等をデータ化したものであり、 誤差を含んでいますので、精緻な作業には使用しないでください。また、国土数値情報ダウンロードサイトコンテンツ利用規約に従い、免責事項・地図の精度に起因する誤差を含むことについて、最終的な利用者まで伝達してください。 ・本データの利用により生じた利用者の損失・損害については、国土交通省ならびに原典資料提供元の各市区町村は一切の責任を負いません。 |                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                |
| ・詳細な情報及び公開条件については各市区町村に必ずお問い合わせください。 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                |
| 備考                                                                     | 国土数値情報としてダウンロード提供不可（公開不可）、又は原典資料が収集できなかった等の理由のため、一部の市区町村ではデータの提供ができません。詳細はこちらからご確認ください。                                                                                                                                                                                                                                                                                                                                                                                          | 国土数値情報としてダウンロード提供不可（公開不可）、又は原典資料が収集できなかった等の理由のため、一部の市区町村ではデータの提供ができません。詳細はこちらからご確認ください。                                                                                 | 国土数値情報としてダウンロード提供不可（公開不可）、又は原典資料が収集できなかった等の理由のため、一部の市区町村ではデータの提供ができません。詳細はこちらからご確認ください。                                                                                 |

``` r
attr_table <- attr_table %>% 
  # 重複を取り除くため
  tibble::as_tibble(.name_repair = "unique")
```

    ## New names:
    ## * 説明 -> 説明...3
    ## * 説明 -> 説明...4

``` r
colnames(attr_table) <- c("_", "name", "description", "type")

attr_table <- attr_table %>% 
  filter(
    `_` == "属性情報",
    # テーブルのヘッダは取り除く
    !startsWith(name, "属性名"),
    !startsWith(name, "地物名"),
    type != "説明",
    # 地物は属性情報ではない
    !stringr::str_detect(stringr::str_remove_all(type, "\\s+"), "^(曲面型|曲線型|点型|GM_Surface|GM_Curve|GM_Point)")
  )

res <- attr_table %>%
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)([（〈][A-Za-z0-9]+_[A-Za-z0-9]+）)?$") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（〈）]"), NA_character_),
    description,
    type
  )

knitr::kable(res)
```

| name           | code     | description                                                 | type                               |
|:---------------|:---------|:------------------------------------------------------------|:-----------------------------------|
| 行政区域コード | A29\_001 | 用途地域がある市区町村の行政コード                          | コードリスト「行政コード」         |
| 都道府県名     | A29\_002 | 用途地域がある都道府県の名称                                | 文字列型（CharacterString）        |
| 市区町村名     | A29\_003 | 用途地域がある市区町村の名称                                | 文字列型（CharacterString）        |
| 用途地域コード | A29\_004 | 用途地域分類コード                                          | コードリスト「用途地域分類コード」 |
| 用途地域名     | A29\_005 | 用途地域の種類の名称                                        | 文字列型（CharacterString）        |
| 建蔽率         | A29\_006 | 用途地域及び指定地域別の建蔽率（%）。不明の時は’9999’とする | 整数型（Decimal）                  |
| 容積率         | A29\_007 | 用途地域及び指定地域別の容積率（%）。不明の時は’9999’とする | 整数型（Decimal）                  |
| 備考           | A29\_008 | 用途地域に関する備考                                        | 文字列型（CharacterString）        |

``` r
readr::write_csv(res, output)
```
