Extract data from A30b
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `A30b`

ここは属性情報テーブルが階層になっているため。ちょっとややこしい。

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-A30b.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                 | 地物名                                                                                                                                                                                                                                                                                                                                                                   | 説明                                                                                                                                                                                                                                                                                                                                                                     | 説明                                                                                                                                                                                                                                                                                                                                                                     | 説明                                                                                                                                                                                                                                                                                                                                                                     |
|:-----------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                 | 竜巻等の突風データ                                                                                                                                                                                                                                                                                                                                                       | 竜巻等の突風について整備したもの                                                                                                                                                                                                                                                                                                                                         | 竜巻等の突風について整備したもの                                                                                                                                                                                                                                                                                                                                         | 竜巻等の突風について整備したもの                                                                                                                                                                                                                                                                                                                                         |
| 属性情報                                 | 属性項目（括弧内はshpの属性記号）                                                                                                                                                                                                                                                                                                                                        | 属性項目（括弧内はshpの属性記号）                                                                                                                                                                                                                                                                                                                                        | 説明                                                                                                                                                                                                                                                                                                                                                                     | 属性の型                                                                                                                                                                                                                                                                                                                                                                 |
| 属性情報                                 | 竜巻等の突風番号（A30b\_001）                                                                                                                                                                                                                                                                                                                                            | 竜巻等の突風番号（A30b\_001）                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                          | 整数型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 竜巻ダウンバースト区別（A30b\_002）                                                                                                                                                                                                                                                                                                                                      | 竜巻ダウンバースト区別（A30b\_002）                                                                                                                                                                                                                                                                                                                                      | 竜巻・ダウンバーストの区別                                                                                                                                                                                                                                                                                                                                               | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 発生                                                                                                                                                                                                                                                                                                                                                                     | 日時（A30b\_003）                                                                                                                                                                                                                                                                                                                                                        | 竜巻やダウンバースト等の突風が発生した日時                                                                                                                                                                                                                                                                                                                               | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 発生                                                                                                                                                                                                                                                                                                                                                                     | 誤差（A30b\_004）                                                                                                                                                                                                                                                                                                                                                        | 竜巻やダウンバースト等の突風が発生した日時の誤差範囲                                                                                                                                                                                                                                                                                                                     | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 発生                                                                                                                                                                                                                                                                                                                                                                     | 都道府県名（A30b\_005）                                                                                                                                                                                                                                                                                                                                                  | 竜巻やダウンバースト等の突風が発生した都道府県名                                                                                                                                                                                                                                                                                                                         | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 発生                                                                                                                                                                                                                                                                                                                                                                     | 市区町村名（A30b\_006）                                                                                                                                                                                                                                                                                                                                                  | 竜巻やダウンバースト等の突風が発生した市区町村名                                                                                                                                                                                                                                                                                                                         | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 発生                                                                                                                                                                                                                                                                                                                                                                     | 番地（A30b\_007）                                                                                                                                                                                                                                                                                                                                                        | 竜巻やダウンバースト等の突風が発生した番地                                                                                                                                                                                                                                                                                                                               | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 消滅                                                                                                                                                                                                                                                                                                                                                                     | 日時（A30b\_008）                                                                                                                                                                                                                                                                                                                                                        | 竜巻やダウンバースト等の突風が消滅した日時                                                                                                                                                                                                                                                                                                                               | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 消滅                                                                                                                                                                                                                                                                                                                                                                     | 誤差（A30b\_009）                                                                                                                                                                                                                                                                                                                                                        | 竜巻やダウンバースト等の突風が消滅した日時の誤差範囲                                                                                                                                                                                                                                                                                                                     | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 消滅                                                                                                                                                                                                                                                                                                                                                                     | 都道府県名（A30b\_010）                                                                                                                                                                                                                                                                                                                                                  | 竜巻やダウンバースト等の突風が消滅した都道府県名                                                                                                                                                                                                                                                                                                                         | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 消滅                                                                                                                                                                                                                                                                                                                                                                     | 市区町村名（A30b\_011）                                                                                                                                                                                                                                                                                                                                                  | 竜巻やダウンバースト等の突風が消滅した市区町村名                                                                                                                                                                                                                                                                                                                         | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 消滅                                                                                                                                                                                                                                                                                                                                                                     | 番地（A30b\_012）                                                                                                                                                                                                                                                                                                                                                        | 竜巻やダウンバースト等の突風が消滅した番地                                                                                                                                                                                                                                                                                                                               | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 藤田スケール（Fスケール）（A30b\_013）                                                                                                                                                                                                                                                                                                                                   | 藤田スケール（Fスケール）（A30b\_013）                                                                                                                                                                                                                                                                                                                                   | 竜巻やダウンバースト等の風速を、構造物などの被害調査から簡便に推定するために、シカゴ大学の藤田哲也氏により1971年に考案された風速のスケール                                                                                                                                                                                                                               | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 被害域                                                                                                                                                                                                                                                                                                                                                                   | 幅（A30b\_014）                                                                                                                                                                                                                                                                                                                                                          | 当該竜巻等の突風による被害域の幅（ｍ）                                                                                                                                                                                                                                                                                                                                   | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 被害域                                                                                                                                                                                                                                                                                                                                                                   | 長さ（A30b\_015）                                                                                                                                                                                                                                                                                                                                                        | 当該竜巻等の突風による被害域の長さ（ｋｍ）                                                                                                                                                                                                                                                                                                                               | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 移動                                                                                                                                                                                                                                                                                                                                                                     | 方向1（A30b\_016）                                                                                                                                                                                                                                                                                                                                                       | 当該竜巻等の突風の移動方向                                                                                                                                                                                                                                                                                                                                               | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 移動                                                                                                                                                                                                                                                                                                                                                                     | 方向2（A30b\_017）                                                                                                                                                                                                                                                                                                                                                       | 当該竜巻等の突風の移動方向                                                                                                                                                                                                                                                                                                                                               | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 移動                                                                                                                                                                                                                                                                                                                                                                     | 速度（A30b\_018）                                                                                                                                                                                                                                                                                                                                                        | 当該竜巻等の突風の移動速度（km/h）                                                                                                                                                                                                                                                                                                                                       | 整数型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 継続時間（A30b\_019）                                                                                                                                                                                                                                                                                                                                                    | 継続時間（A30b\_019）                                                                                                                                                                                                                                                                                                                                                    | 当該竜巻等の突風の継続時間（分）                                                                                                                                                                                                                                                                                                                                         | 整数型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | x回転方向（A30b\_020）                                                                                                                                                                                                                                                                                                                                                   | x回転方向（A30b\_020）                                                                                                                                                                                                                                                                                                                                                   | 当該竜巻等の突風の回転方向                                                                                                                                                                                                                                                                                                                                               | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 発生地点区別（A30b\_021）                                                                                                                                                                                                                                                                                                                                                | 発生地点区別（A30b\_021）                                                                                                                                                                                                                                                                                                                                                | 当該竜巻等の突風の発生地点                                                                                                                                                                                                                                                                                                                                               | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 総観場                                                                                                                                                                                                                                                                                                                                                                   | 1（A30b\_022）                                                                                                                                                                                                                                                                                                                                                           | 当該竜巻等の突風の総観場                                                                                                                                                                                                                                                                                                                                                 | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 総観場                                                                                                                                                                                                                                                                                                                                                                   | 2（A30b\_023）                                                                                                                                                                                                                                                                                                                                                           | 当該竜巻等の突風の総観場                                                                                                                                                                                                                                                                                                                                                 | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 総観場                                                                                                                                                                                                                                                                                                                                                                   | 3（A30b\_024）                                                                                                                                                                                                                                                                                                                                                           | 当該竜巻等の突風の総観場                                                                                                                                                                                                                                                                                                                                                 | 列挙型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 総観規模じょう乱からの位置（A30b\_025）                                                                                                                                                                                                                                                                                                                                  | 総観規模じょう乱からの位置（A30b\_025）                                                                                                                                                                                                                                                                                                                                  | 当該竜巻等の突風の総観規模じょう乱からの位置                                                                                                                                                                                                                                                                                                                             | 整数型                                                                                                                                                                                                                                                                                                                                                                   |
| 属性情報                                 | 特徴（A30b\_026）                                                                                                                                                                                                                                                                                                                                                        | 特徴（A30b\_026）                                                                                                                                                                                                                                                                                                                                                        | 当該竜巻等の突風の特徴                                                                                                                                                                                                                                                                                                                                                   | 文字型                                                                                                                                                                                                                                                                                                                                                                   |
| 主な品質情報                             | ■完全性/過剰・漏れ：　誤率0%データ集合と、参照データ同士の一対一の比較を行い、対応が成立した個数を数え、データ集合から漏れているデータ（エラー）の割合（誤率）を計算する■位置正確度/絶対正確度（外部正確度）：　誤率0%データ集合の位置の座標と、参照データ（”原典資料名”に記載された資料）の座標との誤差を測定する。                                                     | ■完全性/過剰・漏れ：　誤率0%データ集合と、参照データ同士の一対一の比較を行い、対応が成立した個数を数え、データ集合から漏れているデータ（エラー）の割合（誤率）を計算する■位置正確度/絶対正確度（外部正確度）：　誤率0%データ集合の位置の座標と、参照データ（”原典資料名”に記載された資料）の座標との誤差を測定する。                                                     | ■完全性/過剰・漏れ：　誤率0%データ集合と、参照データ同士の一対一の比較を行い、対応が成立した個数を数え、データ集合から漏れているデータ（エラー）の割合（誤率）を計算する■位置正確度/絶対正確度（外部正確度）：　誤率0%データ集合の位置の座標と、参照データ（”原典資料名”に記載された資料）の座標との誤差を測定する。                                                     | NA                                                                                                                                                                                                                                                                                                                                                                       |
| データフォーマット（符号化）             | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。SHAPEファイルの属性について                                                                                                                                                                                                                                           | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。SHAPEファイルの属性について                                                                                                                                                                                                                                           | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。SHAPEファイルの属性について                                                                                                                                                                                                                                           | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・SHAPE形式。SHAPEファイルの属性について                                                                                                                                                                                                                                           |
| 国土情報ウェブマッピングシステムへの登録 | 登録なし                                                                                                                                                                                                                                                                                                                                                                 | 登録なし                                                                                                                                                                                                                                                                                                                                                                 | 登録なし                                                                                                                                                                                                                                                                                                                                                                 | NA                                                                                                                                                                                                                                                                                                                                                                       |
| 識別子                                   | A30b                                                                                                                                                                                                                                                                                                                                                                     | A30b                                                                                                                                                                                                                                                                                                                                                                     | A30b                                                                                                                                                                                                                                                                                                                                                                     | A30b                                                                                                                                                                                                                                                                                                                                                                     |
| その他の情報                             | 各データのメタデータについては、ダウンロードしたファイルに添付されています。Shpデータは発生地点データと消滅地点データの2ファイルあり、属性項目としてA30b\_027発生位置緯度誤差、A30b\_028発生位置経度誤差、A30b\_029発生位置緯度、A30b\_030発生位置経度、A30b\_031消滅位置緯度誤差、A30b\_032消滅位置経度誤差、A30b\_033消滅位置緯度、A30b\_034消滅位置経度が追加される。 | 各データのメタデータについては、ダウンロードしたファイルに添付されています。Shpデータは発生地点データと消滅地点データの2ファイルあり、属性項目としてA30b\_027発生位置緯度誤差、A30b\_028発生位置経度誤差、A30b\_029発生位置緯度、A30b\_030発生位置経度、A30b\_031消滅位置緯度誤差、A30b\_032消滅位置経度誤差、A30b\_033消滅位置緯度、A30b\_034消滅位置経度が追加される。 | 各データのメタデータについては、ダウンロードしたファイルに添付されています。Shpデータは発生地点データと消滅地点データの2ファイルあり、属性項目としてA30b\_027発生位置緯度誤差、A30b\_028発生位置経度誤差、A30b\_029発生位置緯度、A30b\_030発生位置経度、A30b\_031消滅位置緯度誤差、A30b\_032消滅位置経度誤差、A30b\_033消滅位置緯度、A30b\_034消滅位置経度が追加される。 | 各データのメタデータについては、ダウンロードしたファイルに添付されています。Shpデータは発生地点データと消滅地点データの2ファイルあり、属性項目としてA30b\_027発生位置緯度誤差、A30b\_028発生位置経度誤差、A30b\_029発生位置緯度、A30b\_030発生位置経度、A30b\_031消滅位置緯度誤差、A30b\_032消滅位置経度誤差、A30b\_033消滅位置緯度、A30b\_034消滅位置経度が追加される。 |

``` r
attr_table <- attr_table %>% 
  # 重複を取り除くため
  tibble::as_tibble(.name_repair = "unique") %>% 
  filter(地物情報 == "属性情報")
```

    ## New names:
    ## * 説明 -> 説明...3
    ## * 説明 -> 説明...4
    ## * 説明 -> 説明...5

``` r
attr_table <- attr_table %>% 
  slice(-1)

colnames(attr_table) <- c("_", "name1", "name2", "description", "type")

stopifnot(all(!is.na(attr_table$name1)))
stopifnot(all(!is.na(attr_table$name2)))

res <- attr_table %>%
  # name2には、name になるべきものとコードが混在している。まずpasteでくっつけてから extract で抜き出す
  mutate(
    name = if_else(name1 == name2, name1, paste(name1, name2, sep = "_")),
    .keep = "unused"
  ) %>% 
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)(（[A-Za-z0-9]+_[A-Za-z0-9]+）)?$") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（）]"), NA_character_),
    description,
    type
  )

knitr::kable(res)
```

| name                       | code      | description                                                                                                                                | type   |
|:---------------------------|:----------|:-------------------------------------------------------------------------------------------------------------------------------------------|:-------|
| 竜巻等の突風番号           | A30b\_001 |                                                                                                                                            | 整数型 |
| 竜巻ダウンバースト区別     | A30b\_002 | 竜巻・ダウンバーストの区別                                                                                                                 | 列挙型 |
| 発生\_日時                 | A30b\_003 | 竜巻やダウンバースト等の突風が発生した日時                                                                                                 | 文字型 |
| 発生\_誤差                 | A30b\_004 | 竜巻やダウンバースト等の突風が発生した日時の誤差範囲                                                                                       | 文字型 |
| 発生\_都道府県名           | A30b\_005 | 竜巻やダウンバースト等の突風が発生した都道府県名                                                                                           | 文字型 |
| 発生\_市区町村名           | A30b\_006 | 竜巻やダウンバースト等の突風が発生した市区町村名                                                                                           | 文字型 |
| 発生\_番地                 | A30b\_007 | 竜巻やダウンバースト等の突風が発生した番地                                                                                                 | 文字型 |
| 消滅\_日時                 | A30b\_008 | 竜巻やダウンバースト等の突風が消滅した日時                                                                                                 | 文字型 |
| 消滅\_誤差                 | A30b\_009 | 竜巻やダウンバースト等の突風が消滅した日時の誤差範囲                                                                                       | 文字型 |
| 消滅\_都道府県名           | A30b\_010 | 竜巻やダウンバースト等の突風が消滅した都道府県名                                                                                           | 文字型 |
| 消滅\_市区町村名           | A30b\_011 | 竜巻やダウンバースト等の突風が消滅した市区町村名                                                                                           | 文字型 |
| 消滅\_番地                 | A30b\_012 | 竜巻やダウンバースト等の突風が消滅した番地                                                                                                 | 文字型 |
| 藤田スケール（Fスケール）  | A30b\_013 | 竜巻やダウンバースト等の風速を、構造物などの被害調査から簡便に推定するために、シカゴ大学の藤田哲也氏により1971年に考案された風速のスケール | 列挙型 |
| 被害域\_幅                 | A30b\_014 | 当該竜巻等の突風による被害域の幅（ｍ）                                                                                                     | 文字型 |
| 被害域\_長さ               | A30b\_015 | 当該竜巻等の突風による被害域の長さ（ｋｍ）                                                                                                 | 文字型 |
| 移動\_方向1                | A30b\_016 | 当該竜巻等の突風の移動方向                                                                                                                 | 列挙型 |
| 移動\_方向2                | A30b\_017 | 当該竜巻等の突風の移動方向                                                                                                                 | 列挙型 |
| 移動\_速度                 | A30b\_018 | 当該竜巻等の突風の移動速度（km/h）                                                                                                         | 整数型 |
| 継続時間                   | A30b\_019 | 当該竜巻等の突風の継続時間（分）                                                                                                           | 整数型 |
| x回転方向                  | A30b\_020 | 当該竜巻等の突風の回転方向                                                                                                                 | 列挙型 |
| 発生地点区別               | A30b\_021 | 当該竜巻等の突風の発生地点                                                                                                                 | 列挙型 |
| 総観場\_1                  | A30b\_022 | 当該竜巻等の突風の総観場                                                                                                                   | 列挙型 |
| 総観場\_2                  | A30b\_023 | 当該竜巻等の突風の総観場                                                                                                                   | 列挙型 |
| 総観場\_3                  | A30b\_024 | 当該竜巻等の突風の総観場                                                                                                                   | 列挙型 |
| 総観規模じょう乱からの位置 | A30b\_025 | 当該竜巻等の突風の総観規模じょう乱からの位置                                                                                               | 整数型 |
| 特徴                       | A30b\_026 | 当該竜巻等の突風の特徴                                                                                                                     | 文字型 |

``` r
readr::write_csv(res, output)
```
