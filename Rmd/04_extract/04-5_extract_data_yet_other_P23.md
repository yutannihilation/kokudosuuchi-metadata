Extract data from P23
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `P23`

コードが入っている列が2パターンある。 `*`には`a`または`b`が入る。

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-P23.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                 | 地物名                                                                                                                                                                                                 | 地物名                                                                                                                                                                                                 | 説明                                                                                                                                                                                                                             | 説明                                                                                                                                                                                                                             |
|:-----------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                 | 海岸保全施設                                                                                                                                                                                           | 海岸保全施設                                                                                                                                                                                           | 海岸法にもとづく、海岸保全区域内にある堤防、突堤、護岸、胸壁、離岸堤、砂浜（海岸管理者が、消波等の海岸を防護する機能を維持するために設けたもので、指定したものに限る。）その他海水の侵入又は海水による侵食を防止するための施設。 | 海岸法にもとづく、海岸保全区域内にある堤防、突堤、護岸、胸壁、離岸堤、砂浜（海岸管理者が、消波等の海岸を防護する機能を維持するために設けたもので、指定したものに限る。）その他海水の侵入又は海水による侵食を防止するための施設。 |
| 属性情報                                 | 属性名（かっこ内は、shp属性名）                                                                                                                                                                        | 属性名（かっこ内は、shp属性名）                                                                                                                                                                        | 説明                                                                                                                                                                                                                             | 属性の型                                                                                                                                                                                                                         |
| 地物共通項目                             | 位置                                                                                                                                                                                                   | 位置                                                                                                                                                                                                   | 当該施設の位置                                                                                                                                                                                                                   | 点型（GM\_Point）（P23a\_）線型（GM\_Curve）（P23b\_）                                                                                                                                                                           |
| 地物共通項目                             | 行政区域（P23\*\_001）                                                                                                                                                                                 | 行政区域（P23\*\_001）                                                                                                                                                                                 | 施設が立地する海岸保全区域を所管する省庁。                                                                                                                                                                                       | コードリスト型（行政区域コード）                                                                                                                                                                                                 |
| 地物共通項目                             | 所管省庁（P23\*\_002）                                                                                                                                                                                 | 所管省庁（P23\*\_002）                                                                                                                                                                                 | 施設が立地する海岸保全区域を所管する省庁。                                                                                                                                                                                       | 文字列型（CharacterString）                                                                                                                                                                                                      |
| 地物共通項目                             | 管理者（P23\*\_003）                                                                                                                                                                                   | 管理者（P23\*\_003）                                                                                                                                                                                   | 施設が立地する海岸保全区域の海岸管理者の名称                                                                                                                                                                                     | 文字列型（CharacterString）                                                                                                                                                                                                      |
| 地物共通項目                             | 施設種類                                                                                                                                                                                               | 施設種類                                                                                                                                                                                               |                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                  |
| 地物共通項目                             |                                                                                                                                                                                                        | 堤防（P23\*\_004）                                                                                                                                                                                     | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             |                                                                                                                                                                                                        | 突堤（P23\*\_005）                                                                                                                                                                                     | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             |                                                                                                                                                                                                        | 護岸（P23\*\_006）                                                                                                                                                                                     | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             |                                                                                                                                                                                                        | 胸壁（P23\*\_007）                                                                                                                                                                                     | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             |                                                                                                                                                                                                        | 離岸堤（P23\*\_008）                                                                                                                                                                                   | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             |                                                                                                                                                                                                        | 砂浜（P23\*\_009）                                                                                                                                                                                     | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             |                                                                                                                                                                                                        | その他の施設（P23\*\_010）                                                                                                                                                                             | 海岸保全施設の種類。                                                                                                                                                                                                             | 真偽値型（Boolean）                                                                                                                                                                                                              |
| 地物共通項目                             | 延長（P23\*\_011）                                                                                                                                                                                     | 延長（P23\*\_011）                                                                                                                                                                                     | 施設の長さ。単位は「m」。                                                                                                                                                                                                        | 実数型（Real）                                                                                                                                                                                                                   |
| 地物共通項目                             | 基準面（P23\*\_016）                                                                                                                                                                                   | 基準面（P23\*\_016）                                                                                                                                                                                   | 天端高の高さの基準面。潮位観測基準面（DL:Datum Line）、東京湾平均海面（TP：Mean Sea Level of Tokyo Bay） 等がある。                                                                                                              | 文字列型（CharacterString）                                                                                                                                                                                                      |
| 地物共通項目                             | 天端高最大（現況）（P23\*\_012）                                                                                                                                                                       | 天端高最大（現況）（P23\*\_012）                                                                                                                                                                       | 既存施設の天端高の最大値。単位は「m」。                                                                                                                                                                                          | 実数型（Real）                                                                                                                                                                                                                   |
| 地物共通項目                             | 天端高最小（現況）（P23\*\_013）                                                                                                                                                                       | 天端高最小（現況）（P23\*\_013）                                                                                                                                                                       | 既存施設の天端高の最小値。単位は「m」。                                                                                                                                                                                          | 実数型（Real）                                                                                                                                                                                                                   |
| 地物共通項目                             | 天端高最大（計画）（P23\*\_014）                                                                                                                                                                       | 天端高最大（計画）（P23\*\_014）                                                                                                                                                                       | 計画施設の天端高の最大値。単位は「m」。                                                                                                                                                                                          | 実数型（Real）                                                                                                                                                                                                                   |
| 地物共通項目                             | 天端高最小（計画）（P23\*\_015）                                                                                                                                                                       | 天端高最小（計画）（P23\*\_015）                                                                                                                                                                       | 計画施設の天端高の最小値。単位は「m」。                                                                                                                                                                                          | 実数型（Real）                                                                                                                                                                                                                   |
| 主な品質情報                             | ■完全性/過剰・漏れ：誤り数0個原典資料と比較。■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証。                                                                 | ■完全性/過剰・漏れ：誤り数0個原典資料と比較。■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証。                                                                 | ■完全性/過剰・漏れ：誤り数0個原典資料と比較。■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証。                                                                                           | ■完全性/過剰・漏れ：誤り数0個原典資料と比較。■論理一貫性/書式一貫性・概念一貫性・定義域一貫性：誤率0%XMLスキーマに対する妥当性を検証。                                                                                           |
| データフォーマット（符号化）             | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。シェープファイル形式。                                                                                                    | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。シェープファイル形式。                                                                                                    | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。シェープファイル形式。                                                                                                                              | ・GML形式（JPGIS2.1準拠）。詳細は製品仕様書内の符号化規則を参照してください。シェープファイル形式。                                                                                                                              |
| 国土情報ウェブマッピングシステムへの登録 | 登録なし                                                                                                                                                                                               | 登録なし                                                                                                                                                                                               | 登録なし                                                                                                                                                                                                                         | 登録なし                                                                                                                                                                                                                         |
| 識別子                                   | P23                                                                                                                                                                                                    | P23                                                                                                                                                                                                    | P23                                                                                                                                                                                                                              | P23                                                                                                                                                                                                                              |
| その他の情報                             | ・本データは、海岸保全基本計画を主な原典資料として作成されており、海岸保全施設が存在する区域またはその代表点をデータ化したものです。個々の海岸保全施設の形状をそのままデータ化したものではありません。 | ・本データは、海岸保全基本計画を主な原典資料として作成されており、海岸保全施設が存在する区域またはその代表点をデータ化したものです。個々の海岸保全施設の形状をそのままデータ化したものではありません。 | ・本データは、海岸保全基本計画を主な原典資料として作成されており、海岸保全施設が存在する区域またはその代表点をデータ化したものです。個々の海岸保全施設の形状をそのままデータ化したものではありません。                           | ・本データは、海岸保全基本計画を主な原典資料として作成されており、海岸保全施設が存在する区域またはその代表点をデータ化したものです。個々の海岸保全施設の形状をそのままデータ化したものではありません。                           |

``` r
# 便宜上名前を付ける
colnames(attr_table) <- paste0("c", 1:5)

res <- attr_table %>% 
  mutate(
    name = case_when(
      stringr::str_detect(c2, "（P23._[0-9]{3}）") ~ c2,
      stringr::str_detect(c3, "（P23._[0-9]{3}）") ~ c3
    ),
    description = c4,
    type = c5
  ) %>% 
  filter(!is.na(name)) %>% 
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)(（[A-Za-z0-9]+._[A-Za-z0-9]+）)") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（）]"), NA_character_),
    description,
    type
  )
```

`*` を展開する必要がある

``` r
res2 <- res %>%
  rowwise() %>%
  summarise(
    name,
    code = {
      # * を含んでいれば a と b にそれぞれ置き換えた結果を、含んでいなければそのままの結果を
      if (stringr::str_detect(code, stringr::fixed("*"))) {
        stringr::str_replace(code, stringr::fixed("*"), c("a", "b"))
      } else {
        code
      }
    },
    description,
    type
  ) %>% 
  arrange(code)
```

    ## `summarise()` has ungrouped output. You can override using the `.groups` argument.

``` r
knitr::kable(res2)
```

| name               | code      | description                                                                                                         | type                             |
|:-------------------|:----------|:--------------------------------------------------------------------------------------------------------------------|:---------------------------------|
| 行政区域           | P23a\_001 | 施設が立地する海岸保全区域を所管する省庁。                                                                          | コードリスト型（行政区域コード） |
| 所管省庁           | P23a\_002 | 施設が立地する海岸保全区域を所管する省庁。                                                                          | 文字列型（CharacterString）      |
| 管理者             | P23a\_003 | 施設が立地する海岸保全区域の海岸管理者の名称                                                                        | 文字列型（CharacterString）      |
| 堤防               | P23a\_004 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 突堤               | P23a\_005 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 護岸               | P23a\_006 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 胸壁               | P23a\_007 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 離岸堤             | P23a\_008 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 砂浜               | P23a\_009 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| その他の施設       | P23a\_010 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 延長               | P23a\_011 | 施設の長さ。単位は「m」。                                                                                           | 実数型（Real）                   |
| 天端高最大（現況） | P23a\_012 | 既存施設の天端高の最大値。単位は「m」。                                                                             | 実数型（Real）                   |
| 天端高最小（現況） | P23a\_013 | 既存施設の天端高の最小値。単位は「m」。                                                                             | 実数型（Real）                   |
| 天端高最大（計画） | P23a\_014 | 計画施設の天端高の最大値。単位は「m」。                                                                             | 実数型（Real）                   |
| 天端高最小（計画） | P23a\_015 | 計画施設の天端高の最小値。単位は「m」。                                                                             | 実数型（Real）                   |
| 基準面             | P23a\_016 | 天端高の高さの基準面。潮位観測基準面（DL:Datum Line）、東京湾平均海面（TP：Mean Sea Level of Tokyo Bay） 等がある。 | 文字列型（CharacterString）      |
| 行政区域           | P23b\_001 | 施設が立地する海岸保全区域を所管する省庁。                                                                          | コードリスト型（行政区域コード） |
| 所管省庁           | P23b\_002 | 施設が立地する海岸保全区域を所管する省庁。                                                                          | 文字列型（CharacterString）      |
| 管理者             | P23b\_003 | 施設が立地する海岸保全区域の海岸管理者の名称                                                                        | 文字列型（CharacterString）      |
| 堤防               | P23b\_004 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 突堤               | P23b\_005 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 護岸               | P23b\_006 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 胸壁               | P23b\_007 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 離岸堤             | P23b\_008 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 砂浜               | P23b\_009 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| その他の施設       | P23b\_010 | 海岸保全施設の種類。                                                                                                | 真偽値型（Boolean）              |
| 延長               | P23b\_011 | 施設の長さ。単位は「m」。                                                                                           | 実数型（Real）                   |
| 天端高最大（現況） | P23b\_012 | 既存施設の天端高の最大値。単位は「m」。                                                                             | 実数型（Real）                   |
| 天端高最小（現況） | P23b\_013 | 既存施設の天端高の最小値。単位は「m」。                                                                             | 実数型（Real）                   |
| 天端高最大（計画） | P23b\_014 | 計画施設の天端高の最大値。単位は「m」。                                                                             | 実数型（Real）                   |
| 天端高最小（計画） | P23b\_015 | 計画施設の天端高の最小値。単位は「m」。                                                                             | 実数型（Real）                   |
| 基準面             | P23b\_016 | 天端高の高さの基準面。潮位観測基準面（DL:Datum Line）、東京湾平均海面（TP：Mean Sea Level of Tokyo Bay） 等がある。 | 文字列型（CharacterString）      |

``` r
res2 %>% 
  readr::write_csv(output)
```
