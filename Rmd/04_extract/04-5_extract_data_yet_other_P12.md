Extract data from P12
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `P12`

これは災害分類を手動でなんとかする必要がある。

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-P12-v2_2.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table(convert = FALSE) %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

stopifnot(length(attr_table) == 1)
attr_table <- attr_table[[1]]

knitr::kable(attr_table)
```

| 地物情報                                 | 地物名                                                                                                                                                                          | 説明                                                                                                                                                                            | 形状                                                                                                                                                                            |
|:-----------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 地物情報                                 | 観光資源（面）                                                                                                                                                                  | 原典資料に示される地物の空間範囲が面的なもの（「原野」「湖沼」「湿原」「社寺」「城跡・城郭」「庭園・公園」「島」「岬」「歴史景観」等）                                          | 曲面型（GM\_Surface）                                                                                                                                                           |
| 地物情報                                 | 観光資源（線）                                                                                                                                                                  | 原典資料に示される地物の空間範囲が線的なもの（河川、海岸、峡谷等）                                                                                                              | 線型（GM\_Curve）                                                                                                                                                               |
| 地物情報                                 | 観光資源（点）                                                                                                                                                                  | 原典資料に示される地物の中心部や中心点とみなされる地点                                                                                                                          | 点型（GM\_Point）                                                                                                                                                               |
| 地物情報                                 | 属性名（かっこ内はシェープファイルの属性名）                                                                                                                                    | 説明                                                                                                                                                                            | 属性の型                                                                                                                                                                        |
| 地物情報                                 | 観光資源\_ID（P12\_001）※観光資源\_IDはシェープファイルのみ                                                                                                                     | 観光資源ごとの整理番号                                                                                                                                                          | 整数型（Integer）                                                                                                                                                               |
| 地物情報                                 | 観光資源名（P12\_002）                                                                                                                                                          | 観光資源の代表的名称                                                                                                                                                            | 文字列型（CharacterString）                                                                                                                                                     |
| 地物情報                                 | 都道府県コード（P12\_003）                                                                                                                                                      | 観光資源が属する都道府県の都道府県コ－ド                                                                                                                                        | コードリスト「都道府県コード」                                                                                                                                                  |
| 地物情報                                 | 行政コード（P12\_004）                                                                                                                                                          | 観光資源が属する市区町村の市区町村コ－ド                                                                                                                                        | コードリスト「行政コード」                                                                                                                                                      |
| 地物情報                                 | 種別名称（P12\_005）                                                                                                                                                            | 観光資源の種別名                                                                                                                                                                | 文字列型（CharacterString）                                                                                                                                                     |
| 地物情報                                 | 所在地住所（P12\_006）                                                                                                                                                          | 観光資源の平成26（2014）年3月時点の所在地住所                                                                                                                                   | 文字列型（CharacterString）                                                                                                                                                     |
| 地物情報                                 | 観光資源分類コード（P12\_007）                                                                                                                                                  | 観光資源の中分類に該当する区分                                                                                                                                                  | コードリスト「観光資源分類コード」                                                                                                                                              |
| ※観光資源\_IDはシェープファイルのみ      | ※観光資源\_IDはシェープファイルのみ                                                                                                                                             | ※観光資源\_IDはシェープファイルのみ                                                                                                                                             | ※観光資源\_IDはシェープファイルのみ                                                                                                                                             |
| 主な品質情報                             | ■ 完全性/過剰・漏れ：　誤率0%■ 論理一貫性/書式一貫性・概念一貫性・定義域一貫性：　誤率0%■ 位置正確度/絶対正確度：　図上0.3mm以内■ 主題正確度/非定量的主題属性の正しさ：　誤率0% | ■ 完全性/過剰・漏れ：　誤率0%■ 論理一貫性/書式一貫性・概念一貫性・定義域一貫性：　誤率0%■ 位置正確度/絶対正確度：　図上0.3mm以内■ 主題正確度/非定量的主題属性の正しさ：　誤率0% | ■ 完全性/過剰・漏れ：　誤率0%■ 論理一貫性/書式一貫性・概念一貫性・定義域一貫性：　誤率0%■ 位置正確度/絶対正確度：　図上0.3mm以内■ 主題正確度/非定量的主題属性の正しさ：　誤率0% |
| データフォーマット（符号化）             | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。                                                                  | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。                                                                  | ・JPGISに準拠した符号化（GML形式）。詳細は製品仕様書内の符号化規則を参照してください。・シェープファイル形式。                                                                  |
| 国土情報ウェブマッピングシステムへの登録 | 登録なし                                                                                                                                                                        | 登録なし                                                                                                                                                                        | 登録なし                                                                                                                                                                        |
| その他                                   |                                                                                                                                                                                 |                                                                                                                                                                                 |                                                                                                                                                                                 |
| 識別子                                   | P12                                                                                                                                                                             | P12                                                                                                                                                                             | P12                                                                                                                                                                             |
| その他の情報                             | 各データのメタデータについては、ダウンロードしたファイルに添付されています。                                                                                                    | 各データのメタデータについては、ダウンロードしたファイルに添付されています。                                                                                                    | 各データのメタデータについては、ダウンロードしたファイルに添付されています。                                                                                                    |

``` r
colnames(attr_table) <- c("_", "name", "description", "type")

attr_table <- attr_table %>% 
  filter(
    # 名前が違う
    `_` == "地物情報",
    # テーブルのヘッダは取り除く
    !startsWith(name, "属性名"),
    !startsWith(name, "地物名"),
    type != "説明",
    # 地物は属性情報ではない
    !stringr::str_detect(stringr::str_remove_all(type, "\\s+"), "^(曲面型|曲線型|点型|GM_Surface|GM_Curve|GM_Point)")
  )

res <- attr_table %>%
  tidyr::extract(name, into = c("name", "code"), regex = "(.*?)(（[A-Za-z0-9]+_[A-Za-z0-9]+）)") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（）]"), NA_character_),
    description,
    type
  ) %>% 
  filter(!is.na(code))
```

最後の行もいらなそうなので消しておく

``` r
knitr::kable(res)
```

| name               | code     | description                                   | type                               |
|:-------------------|:---------|:----------------------------------------------|:-----------------------------------|
| 観光資源\_ID       | P12\_001 | 観光資源ごとの整理番号                        | 整数型（Integer）                  |
| 観光資源名         | P12\_002 | 観光資源の代表的名称                          | 文字列型（CharacterString）        |
| 都道府県コード     | P12\_003 | 観光資源が属する都道府県の都道府県コ－ド      | コードリスト「都道府県コード」     |
| 行政コード         | P12\_004 | 観光資源が属する市区町村の市区町村コ－ド      | コードリスト「行政コード」         |
| 種別名称           | P12\_005 | 観光資源の種別名                              | 文字列型（CharacterString）        |
| 所在地住所         | P12\_006 | 観光資源の平成26（2014）年3月時点の所在地住所 | 文字列型（CharacterString）        |
| 観光資源分類コード | P12\_007 | 観光資源の中分類に該当する区分                | コードリスト「観光資源分類コード」 |

``` r
res %>% 
  readr::write_csv(output)
```
