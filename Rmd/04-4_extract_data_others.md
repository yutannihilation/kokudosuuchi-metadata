Extract data
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

``` r
datalist_files <- list.files(here::here("data-raw", "datalist"), full.names = TRUE)
id <- stringr::str_replace(basename(datalist_files), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")

idx_exclude <- id %in% c("C23", "A09", "A20", "A31", "S10a")
datalist_files <- datalist_files[!idx_exclude]
id <- id[!idx_exclude]

names(datalist_files) <- id

tables <- purrr::map(datalist_files, ~ {
  read_html(.x) %>% 
    html_table() %>% 
    purrr::keep(~ "地物情報" == colnames(.x)[1])
})

# テーブル一つだけなことを確認
stopifnot(all(lengths(tables) == 1L))

# 確認したら、アクセスしやすくするために一段階減らす
tables <- purrr::map(tables, 1L)
```

属性情報をもたないテーブルは取り除く

``` r
no_attr_info <- names(tables)[purrr::map_lgl(tables, ~ !"属性情報" %in% .x[[1]])]
no_attr_info
```

    ## [1] "L03-b_r" "P03"     "P12"     "P33"

``` r
id <- id[!id %in% no_attr_info]
tables <- tables[!names(tables) %in% no_attr_info]
```

``` r
tables <- tables %>% 
  purrr::imap(~ {
    # 属性情報の行だけにする
    .x <- .x[startsWith(.x[[1]], "属性情報"), , drop = FALSE]
    # 1行目はヘッダ
    nm <- .x[1, ]
    .x <- .x[-1, ]
    colnames(.x) <- nm
    # すべてNAの列は取り除く
    idx <- purrr::map_lgl(.x, ~ any(!is.na(.)))
    .x[, idx]
  })
```

属性情報の行が1行だけのテーブルも取り除く

``` r
no_rows <- names(tables)[purrr::map_lgl(tables, ~ nrow(.x) == 0)]
no_rows
```

    ## [1] "mesh1000h30" "mesh500h30"  "P22"         "P23"

``` r
id <- id[!id %in% no_rows]
tables <- tables[!names(tables) %in% no_rows]
```

カラム数は4のはずだが、ちがうやつがあるので調べる。

``` r
names(tables)[lengths(tables) != 4L]
```

    ##  [1] "A29"   "A30b"  "L01"   "L02"   "L05"   "N08"   "P20"   "P26"   "S05-a"
    ## [10] "S05-b"

``` r
unexpected_tables <- tables[lengths(tables) != 4L]
```

``` r
purrr::map(unexpected_tables, head) %>% 
  purrr::walk(~ print(knitr::kable(.x)))
```

| 属性情報 | 属性名（かっこ内はshp属性名） | 説明                                                             | 属性の型                           | NA  |
|:---------|:------------------------------|:-----------------------------------------------------------------|:-----------------------------------|:----|
| 属性情報 | 範囲                          | 用途地域として参照図（都市計画総括図など）に記載された地域の範囲 | 曲面型（GM\_Surface）              | NA  |
| 属性情報 | 行政区域コード（A29\_001）    | 用途地域がある市区町村の行政コード                               | コードリスト「行政コード」         | NA  |
| 属性情報 | 都道府県名（A29\_002）        | 用途地域がある都道府県の名称                                     | 文字列型（CharacterString）        | NA  |
| 属性情報 | 市区町村名（A29\_003）        | 用途地域がある市区町村の名称                                     | 文字列型（CharacterString）        | NA  |
| 属性情報 | 用途地域コード（A29\_004）    | 用途地域分類コード                                               | コードリスト「用途地域分類コード」 | NA  |
| 属性情報 | 用途地域名（A29\_005）        | 用途地域の種類の名称                                             | 文字列型（CharacterString）        | NA  |

| 属性情報 | 属性項目（括弧内はshpの属性記号）   | 属性項目（括弧内はshpの属性記号）   | 説明                                                 | 属性の型 |
|:---------|:------------------------------------|:------------------------------------|:-----------------------------------------------------|:---------|
| 属性情報 | 竜巻等の突風番号（A30b\_001）       | 竜巻等の突風番号（A30b\_001）       |                                                      | 整数型   |
| 属性情報 | 竜巻ダウンバースト区別（A30b\_002） | 竜巻ダウンバースト区別（A30b\_002） | 竜巻・ダウンバーストの区別                           | 列挙型   |
| 属性情報 | 発生                                | 日時（A30b\_003）                   | 竜巻やダウンバースト等の突風が発生した日時           | 文字型   |
| 属性情報 | 発生                                | 誤差（A30b\_004）                   | 竜巻やダウンバースト等の突風が発生した日時の誤差範囲 | 文字型   |
| 属性情報 | 発生                                | 都道府県名（A30b\_005）             | 竜巻やダウンバースト等の突風が発生した都道府県名     | 文字型   |
| 属性情報 | 発生                                | 市区町村名（A30b\_006）             | 竜巻やダウンバースト等の突風が発生した市区町村名     | 文字型   |

| 属性情報 | 属性名             | 属性名             | 説明                                   | 属性の型                    |
|:---------|:-------------------|:-------------------|:---------------------------------------|:----------------------------|
| 属性情報 | 標準地コード       | 標準地コード       | 地価公示の標準地に付される番号         |                             |
| 属性情報 |                    | 見出し番号         |                                        | コードリスト「見出し番号」  |
| 属性情報 |                    | 一連番号           |                                        | 文字列型（CharacterString） |
| 属性情報 | 前年度標準地コード | 前年度標準地コード | 当該標準地における前年度の標準地コード |                             |
| 属性情報 |                    | 見出し番号         |                                        | コードリスト「見出し番号」  |
| 属性情報 |                    | 一連番号           |                                        | 文字列型（CharacterString） |

| 属性情報 | 属性名       | 属性名       | 説明                                   | 属性の型       |
|:---------|:-------------|:-------------|:---------------------------------------|:---------------|
| 属性情報 | 基準地コード | 基準地コード | 都道府県地価調査の基準地に付された番号 |                |
| 属性情報 |              | 見出し番号   | 「見出し番号」がとりうる値             | コードリスト「 |

                           見出し番号
                       
                       」 |

\|属性情報 \| \|一連番号 \| \|文字列型（CharacterString） \| \|属性情報
\|前年度基準地コード \|前年度基準地コード
\|当該基準地における前年度の基準地コード \| \| \|属性情報 \|
\|見出し番号 \| \|コードリスト「

                           見出し番号
                       
                       」 |

\|属性情報 \| \|一連番号 \| \|文字列型（CharacterString） \|

| 属性情報 | 属性名                           | 説明                                                                                                       | 説明                                                                                                       | 説明                                                                                                       | 属性の型                             |
|:---------|:---------------------------------|:-----------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------|:-------------------------------------|
| 属性情報 | 工業用地ID（L01\_001）           | 工業用地の識別番号都道府県コード＋用地番号＋地区番号の7桁の番号                                            | 工業用地の識別番号都道府県コード＋用地番号＋地区番号の7桁の番号                                            | 工業用地の識別番号都道府県コード＋用地番号＋地区番号の7桁の番号                                            | 整数型（Integer）                    |
| 属性情報 | 工業用地名（L01\_002）           | 工業団地名または単独工場の名称                                                                             | 工業団地名または単独工場の名称                                                                             | 工業団地名または単独工場の名称                                                                             | 文字列型（CharacterString）          |
| 属性情報 | 行政コード（L01\_003）           | 都道府県コードと市区町村コードからなる，行政区を特定するためのコードJIS 規格（JIS X 0401，JIS X 0402）準拠 | 都道府県コードと市区町村コードからなる，行政区を特定するためのコードJIS 規格（JIS X 0401，JIS X 0402）準拠 | 都道府県コードと市区町村コードからなる，行政区を特定するためのコードJIS 規格（JIS X 0401，JIS X 0402）準拠 | コードリスト「行政コード」           |
| 属性情報 | 市区町村名（L01\_004）           | 当該単独工場用地が属する市区町村名                                                                         | 当該単独工場用地が属する市区町村名                                                                         | 当該単独工場用地が属する市区町村名                                                                         | 文字列型（CharacterString）          |
| 属性情報 | 臨海・内陸区分コード（L01\_005） | 当該単独工場用地が存在する位置の番号1：臨海　2：内陸                                                       | 当該単独工場用地が存在する位置の番号1：臨海　2：内陸                                                       | 当該単独工場用地が存在する位置の番号1：臨海　2：内陸                                                       | コードリスト「臨海・内陸区分コード」 |
| 属性情報 | 特記事項（L01\_006）             | 当該工業団地についての開発経緯や特色など、特別な事項を記載                                                 | 当該工業団地についての開発経緯や特色など、特別な事項を記載                                                 | 当該工業団地についての開発経緯や特色など、特別な事項を記載                                                 | 文字列型（CharacterString）          |

| 属性情報 | 属性名（かっこ内はshp属性名） | 説明                               | 属性の型                             | NA  |
|:---------|:------------------------------|:-----------------------------------|:-------------------------------------|:----|
| 属性情報 | 空港区域                      | 空港区域の位置                     | 曲面型（GM\_Surface）                | NA  |
| 属性情報 | 行政区域（N08\_001）          | 空港区域のある市区町村の行政コード | コードリスト「行政コード」           | NA  |
| 属性情報 | 空港種別（N08\_002）          | 空港の種類による区別               | コードリスト「空港種別コード」       | NA  |
| 属性情報 | 空港名称（N08\_003）          | 空港の名称                         | 文字列型（CharacterString）          | NA  |
| 属性情報 | 設置者（N08\_004）            | 空港を設立した組織                 | コードリスト「設置者・管理者コード」 | NA  |
| 属性情報 | 管理者（N08\_005）            | 空港を管理している組織             | コードリスト「設置者・管理者コード」 | NA  |

| 属性情報 | 属性名（かっこ内はshp属性） | 説明                                                                                   | 説明                                                                                   | 属性の型                         | NA  |
|:---------|:----------------------------|:---------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------|:---------------------------------|:----|
| 属性情報 | 位置                        | 避難施設の位置                                                                         | 避難施設の位置                                                                         | GM\_ Point                       | NA  |
| 属性情報 | 行政区域（P20\_001）        | 都道府県コードと市区町村コードからなる，避難施設の所在する行政区を特定するためのコード | 都道府県コードと市区町村コードからなる，避難施設の所在する行政区を特定するためのコード | コードリスト型（行政区域コード） | NA  |
| 属性情報 | 名称（P20\_002）            | 避難施設の名称                                                                         | 避難施設の名称                                                                         | 文字列型                         | NA  |
| 属性情報 | 住所（P20\_003）            | 避難施設の住所                                                                         | 避難施設の住所                                                                         | 文字列型                         | NA  |
| 属性情報 | 施設の種類（P20\_004）      | 避難施設の種類                                                                         | 避難施設の種類                                                                         | 文字列型                         | NA  |
| 属性情報 | 収容人数（P20\_005）        | 避難施設の形態ごとの収容可能人数                                                       | 避難施設の形態ごとの収容可能人数                                                       | 整数値型                         | NA  |

| 属性情報 | 属性名（かっこ内はshp属性名）  | 説明                                                                                       | 属性の型                     | NA  |
|:---------|:-------------------------------|:-------------------------------------------------------------------------------------------|:-----------------------------|:----|
| 属性情報 | 位置                           | 当該ニュータウンの代表位置．                                                               | 点型（GM\_ Point）           | NA  |
| 属性情報 | 都道府県名（P26\_001）         | 各ニュータウンの所在する都道府県名．                                                       | 文字列型                     | NA  |
| 属性情報 | 市区町村名 （P26\_002）        | 各ニュータウンの所在する市町村名．                                                         | 文字列型                     | NA  |
| 属性情報 | 地方公共団体コード〈P26\_003） | 都道府県コードと市区町村コードからなる，ニュータウンが存在する行政区を特定するためのコード | コードリスト型「行政コード」 | NA  |
| 属性情報 | 地区名 （P26\_004）            | 住宅・宅地開発事業に使用された地区名．                                                     | 文字列型                     | NA  |
| 属性情報 | 愛称名 （P26\_005）            | 宅地分譲等が行われた時の愛称等．                                                           | 文字列型                     | NA  |

| 属性情報 | 属性名              | 説明                                       | 属性の型                                                                                                                                                 | NA  |
|:---------|:--------------------|:-------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------|:----|
| 属性情報 | 都市圏              | 都市圏の分類                               | コードリスト「都市圏コード」                                                                                                                             | NA  |
| 属性情報 | 調査年度            | パーソントリップ調査の実施年度             | 整数型                                                                                                                                                   | NA  |
| 属性情報 | 発生集中            | 発生集中の分類                             | コードリスト「発生集中コード」                                                                                                                           | NA  |
| 属性情報 | ゾーンコード        | 集計ゾーンのコード                         | コードリスト「東京都市圏ゾーンコード」「近畿圏H12年度ゾーンコード」「近畿圏H22年度ゾーンコード」「中京都市圏H13年度ゾーンコード」「H23年度ゾーンコード」 | NA  |
| 属性情報 | 鉄道-出勤トリップ数 | 交通手段「鉄道」、目的「出勤」のトリップ数 | 整数型                                                                                                                                                   | NA  |
| 属性情報 | 鉄道-登校トリップ数 | 交通手段「鉄道」、目的「登校」のトリップ数 | 整数型                                                                                                                                                   | NA  |

| 属性情報 | 属性名              | 説明                                       | 属性の型                                                                                                                                                 | NA  |
|:---------|:--------------------|:-------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------|:----|
| 属性情報 | 都市圏              | 都市圏の分類                               | コードリスト「都市圏コード」                                                                                                                             | NA  |
| 属性情報 | 調査年度            | パーソントリップ調査の実施年度             | 整数型                                                                                                                                                   | NA  |
| 属性情報 | 発ゾーンコード      | ＯＤ量の発ゾーンのコード                   | コードリスト「東京都市圏ゾーンコード」「近畿圏H12年度ゾーンコード」「近畿圏H22年度ゾーンコード」「中京都市圏H13年度ゾーンコード」「H23年度ゾーンコード」 | NA  |
| 属性情報 | 着ゾーンコード      | ＯＤ量の着ゾーンのコード                   | コードリスト「東京都市圏ゾーンコード」「近畿圏H12年度ゾーンコード」「近畿圏H22年度ゾーンコード」「中京都市圏H13年度ゾーンコード」「H23年度ゾーンコード」 | NA  |
| 属性情報 | 鉄道-出勤トリップ数 | 交通手段「鉄道」、目的「出勤」のトリップ数 | 整数型                                                                                                                                                   | NA  |
| 属性情報 | 鉄道-登校トリップ数 | 交通手段「鉄道」、目的「登校」のトリップ数 | 整数型                                                                                                                                                   | NA  |
