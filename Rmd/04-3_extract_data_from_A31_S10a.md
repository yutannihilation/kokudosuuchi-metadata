Extract data from A31-v2\_1 and S10a-v1\_2
================

``` r
library(rvest)
library(dplyr, warn.conflicts = FALSE)

dir.create(here::here("data", "attrs"), recursive = TRUE, showWarnings = FALSE)
```

### `A31-v2_1`

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-A31-v2_1.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table() %>% 
  purrr::keep(~ "地物情報" %in% colnames(.x))

res <- attr_table %>% 
  purrr::map(~ dplyr::filter(.x, 地物情報 == "属性情報")) %>% 
  # 1行目はヘッダ
  purrr::map(~ {
    res <- slice(.x, -1)
    colnames(res) <- slice(.x, 1)
    res
  }) %>% 
  bind_rows() %>% 
  tidyr::extract(属性名, into = c("name", "code"), regex = "([^（]*)(（.*）)?") %>% 
  transmute(
    name,
    code = if_else(code != '', stringr::str_remove_all(code, "[（）]"), NA_character_),
    description = 説明,
    type = 属性の型
  )

knitr::kable(res)
```

| name                 | code     | description                                                                            | type                                       |
|:---------------------|:---------|:---------------------------------------------------------------------------------------|:-------------------------------------------|
| 範囲                 | NA       | 浸水想定区域の範囲                                                                     | 面型（GM\_ Surface）                       |
| 浸水深ランク         | A31\_101 | 当該洪水浸水想定区域図に示されている浸水深から得られた浸水深のランクコード             | コードリスト型（浸水深ランクコード）       |
| 指定年月日           | A31\_102 | 当該洪水浸水想定区域を指定した年月日                                                   | 文字列型（CharacterString）                |
| 告示番号             | A31\_103 | 当該洪水浸水想定区域を告示した際の公告番号                                             | 文字列型（CharacterString）                |
| 指定の前提となる降雨 | A31\_104 | 当該洪水浸水想定区域の指定の前提となる計画降雨                                         | 文字列型（CharacterString）                |
| 浸水深ランク         | A31\_201 | 当該洪水浸水想定区域図に示されている浸水深から得られた浸水深のランクコード             | コードリスト型（浸水深ランクコード）       |
| 指定年月日           | A31\_202 | 当該洪水浸水想定区域を指定した年月日                                                   | 文字列型（CharacterString）                |
| 告示番号             | A31\_203 | 当該洪水浸水想定区域を告示した際の公告番号                                             | 文字列型（CharacterString）                |
| 指定の前提となる降雨 | A31\_204 | 当該洪水浸水想定区域の指定の前提となる計画降雨                                         | 文字列型（CharacterString）                |
| 浸水継続時間ランク   | A31\_301 | 当該洪水浸水想定区域図に示されている浸水継続時間から得られた浸水継続時間のランクコード | コードリスト型（浸水継続時間ランクコード） |
| 指定年月日           | A31\_302 | 当該洪水浸水想定区域を指定した年月日                                                   | 文字列型（CharacterString）                |
| 告示番号             | A31\_303 | 当該洪水浸水想定区域を告示した際の公告番号                                             | 文字列型（CharacterString）                |
| 指定の前提となる降雨 | A31\_304 | 当該洪水浸水想定区域の指定の前提となる計画降雨                                         | 文字列型（CharacterString）                |
| 危険区域区分         | A31\_401 | 当該洪水浸水想定区域図に示されている危険区域区分から、得られた危険区域区分コード       | コードリスト型（危険区域区分コード）       |
| 指定年月日           | A31\_402 | 当該洪水浸水想定区域を指定した年月日                                                   | 文字列型（CharacterString）                |
| 告示番号             | A31\_403 | 当該洪水浸水想定区域を告示した際の公告番号                                             | 文字列型（CharacterString）                |
| 指定の前提となる降雨 | A31\_404 | 当該洪水浸水想定区域の指定の前提となる計画降雨                                         | 文字列型（CharacterString）                |

``` r
readr::write_csv(res, output)
```

### `S10a-v1_2`

``` r
input <- here::here("data-raw", "datalist", "KsjTmplt-S10a-v1_2.html")
id <- stringr::str_replace(basename(input), "(?:KsjTmplt-)(.*?)(?:-v.*)?(?:\\.html)", "\\1")
output <- here::here("data", "attrs", glue::glue("{id}.csv"))

attr_table <- read_html(input) %>% 
  html_table()
```

これの場合は、属性情報のカラムが2つ分あるらしく、dplyr
でうまく操作できない。

``` r
colnames(attr_table[[4]])
```

    ## [1] "地物情報" "地物情報" "地物名"   "地物名"   "説明"     "説明"     "説明"    
    ## [8] ""

``` r
colnames(attr_table[[5]])
```

    ## [1] "地物情報" "地物情報" "地物名"   "地物名"   "説明"     "説明"     "説明"    
    ## [8] ""         ""

今回は、テーブルは無視して、こっちの`/codelist/`の先のリストを見るほうがよさそう。

``` r
links_in_table <- read_html(input) %>% 
  html_elements("table.tablelist a")
```

``` r
library(polite)
page <- bow("https://nlftp.mlit.go.jp/ksj/gml/codelist/PortRouteCd.html") %>% 
  scrape()

tables <- page %>% 
  html_table(header = TRUE)

stopifnot(length(tables) == 1)

knitr::kable(tables[[1]])
```

| 地物         | 属性           |                                           | shp属性名 |
|:-------------|:---------------|:------------------------------------------|:----------|
| 港湾間流通量 | 出発港         | 都道府県                                  | S10a\_001 |
| 港湾間流通量 | 出発港         | 港湾名                                    | S10a\_002 |
| 港湾間流通量 | 到着港         | 都道府県                                  | S10a\_003 |
| 港湾間流通量 | 到着港         | 港湾名                                    | S10a\_004 |
| 港湾間流通量 | 頻度           | 貨客船定期便就航数                        | S10a\_005 |
| 港湾間流通量 | 頻度           | フェリー定期便就航数                      | S10a\_006 |
| 港湾間流通量 | 頻度           | 貨物船定期便就航数                        | S10a\_007 |
| 港湾間流通量 | 頻度           | RORO船定期便就航数                        | S10a\_008 |
| 港湾間流通量 | 運搬可能旅客数 |                                           | S10a\_009 |
| 港湾間流通量 | 積載可能貨物量 | トラック                                  | S10a\_010 |
| 港湾間流通量 | 積載可能貨物量 | シャーシ                                  | S10a\_011 |
| 港湾間流通量 | 積載可能貨物量 | トレーラー                                | S10a\_012 |
| 港湾間流通量 | 積載可能貨物量 | 中型車                                    | S10a\_013 |
| 港湾間流通量 | 積載可能貨物量 | 乗用車                                    | S10a\_014 |
| 港湾間流通量 | 積載可能貨物量 | コンテナ                                  | S10a\_015 |
| 港湾間流通量 | 積載可能貨物量 | その他                                    | S10a\_016 |
| 港湾間流通量 | 積載可能貨物量 | 化成品                                    | S10a\_017 |
| 港湾間流通量 | 大分類流通量   | 農水産品                                  | S10a\_018 |
| 港湾間流通量 | 大分類流通量   | 林産品                                    | S10a\_019 |
| 港湾間流通量 | 大分類流通量   | 鉱産品                                    | S10a\_020 |
| 港湾間流通量 | 大分類流通量   | 金属機械工業品                            | S10a\_021 |
| 港湾間流通量 | 大分類流通量   | 化学工業品                                | S10a\_022 |
| 港湾間流通量 | 大分類流通量   | 軽工業品                                  | S10a\_023 |
| 港湾間流通量 | 大分類流通量   | 雑工業品                                  | S10a\_024 |
| 港湾間流通量 | 大分類流通量   | 特殊品                                    | S10a\_025 |
| 港湾間流通量 | 大分類流通量   | 分類不能のもの（大分類）                  | S10a\_026 |
| 港湾間流通量 | 中分類流通量   | 011麦                                     | S10a\_027 |
| 港湾間流通量 | 中分類流通量   | 021米                                     | S10a\_028 |
| 港湾間流通量 | 中分類流通量   | 022とうもろこし                           | S10a\_029 |
| 港湾間流通量 | 中分類流通量   | 023豆類                                   | S10a\_030 |
| 港湾間流通量 | 中分類流通量   | 024その他雑穀                             | S10a\_031 |
| 港湾間流通量 | 中分類流通量   | 031野菜・果物                             | S10a\_032 |
| 港湾間流通量 | 中分類流通量   | 041綿花                                   | S10a\_033 |
| 港湾間流通量 | 中分類流通量   | 051その他農産品                           | S10a\_034 |
| 港湾間流通量 | 中分類流通量   | 061羊毛                                   | S10a\_035 |
| 港湾間流通量 | 中分類流通量   | 071その他畜産品                           | S10a\_036 |
| 港湾間流通量 | 中分類流通量   | 081水産品                                 | S10a\_037 |
| 港湾間流通量 | 中分類流通量   | 091原木                                   | S10a\_038 |
| 港湾間流通量 | 中分類流通量   | 092製材                                   | S10a\_039 |
| 港湾間流通量 | 中分類流通量   | 101樹脂類                                 | S10a\_040 |
| 港湾間流通量 | 中分類流通量   | 111木材チップ                             | S10a\_041 |
| 港湾間流通量 | 中分類流通量   | 112その他林産品                           | S10a\_042 |
| 港湾間流通量 | 中分類流通量   | 121薪炭                                   | S10a\_043 |
| 港湾間流通量 | 中分類流通量   | 131石炭                                   | S10a\_044 |
| 港湾間流通量 | 中分類流通量   | 141鉄鉱石                                 | S10a\_045 |
| 港湾間流通量 | 中分類流通量   | 151金属鉱                                 | S10a\_046 |
| 港湾間流通量 | 中分類流通量   | 161砂利・砂                               | S10a\_047 |
| 港湾間流通量 | 中分類流通量   | 162石材                                   | S10a\_048 |
| 港湾間流通量 | 中分類流通量   | 171原油                                   | S10a\_049 |
| 港湾間流通量 | 中分類流通量   | 181りん鉱石                               | S10a\_050 |
| 港湾間流通量 | 中分類流通量   | 191石灰石                                 | S10a\_051 |
| 港湾間流通量 | 中分類流通量   | 201原塩                                   | S10a\_052 |
| 港湾間流通量 | 中分類流通量   | 211非金属鉱物                             | S10a\_053 |
| 港湾間流通量 | 中分類流通量   | 221鉄鋼                                   | S10a\_054 |
| 港湾間流通量 | 中分類流通量   | 222鋼材                                   | S10a\_055 |
| 港湾間流通量 | 中分類流通量   | 231非鉄金属                               | S10a\_056 |
| 港湾間流通量 | 中分類流通量   | 241金属製品                               | S10a\_057 |
| 港湾間流通量 | 中分類流通量   | 251鉄道車両                               | S10a\_058 |
| 港湾間流通量 | 中分類流通量   | 252完成自動車                             | S10a\_059 |
| 港湾間流通量 | 中分類流通量   | 253その他輸送用車両                       | S10a\_060 |
| 港湾間流通量 | 中分類流通量   | 254二輪自動車                             | S10a\_061 |
| 港湾間流通量 | 中分類流通量   | 255自動車部品                             | S10a\_062 |
| 港湾間流通量 | 中分類流通量   | 256その他輸送機械                         | S10a\_063 |
| 港湾間流通量 | 中分類流通量   | 261産業機械                               | S10a\_064 |
| 港湾間流通量 | 中分類流通量   | 262電気機械                               | S10a\_065 |
| 港湾間流通量 | 中分類流通量   | 263測量・光学・医療用器械                 | S10a\_066 |
| 港湾間流通量 | 中分類流通量   | 264事務用機器                             | S10a\_067 |
| 港湾間流通量 | 中分類流通量   | 265その他機械                             | S10a\_068 |
| 港湾間流通量 | 中分類流通量   | 271陶磁器                                 | S10a\_069 |
| 港湾間流通量 | 中分類流通量   | 281セメント                               | S10a\_070 |
| 港湾間流通量 | 中分類流通量   | 291ガラス類                               | S10a\_071 |
| 港湾間流通量 | 中分類流通量   | 301窯業品                                 | S10a\_072 |
| 港湾間流通量 | 中分類流通量   | 311重油                                   | S10a\_073 |
| 港湾間流通量 | 中分類流通量   | 321石油製品                               | S10a\_074 |
| 港湾間流通量 | 中分類流通量   | 322LNG（液化天然ガス）                    | S10a\_075 |
| 港湾間流通量 | 中分類流通量   | 323LPG（液化石油ガス）                    | S10a\_076 |
| 港湾間流通量 | 中分類流通量   | 324その他石油製品                         | S10a\_077 |
| 港湾間流通量 | 中分類流通量   | 331コークス                               | S10a\_078 |
| 港湾間流通量 | 中分類流通量   | 341石炭製品                               | S10a\_079 |
| 港湾間流通量 | 中分類流通量   | 351化学薬品                               | S10a\_080 |
| 港湾間流通量 | 中分類流通量   | 361化学肥料                               | S10a\_081 |
| 港湾間流通量 | 中分類流通量   | 371染料・塗料・合成樹脂・その他化学工業品 | S10a\_082 |
| 港湾間流通量 | 中分類流通量   | 381紙・パルプ                             | S10a\_083 |
| 港湾間流通量 | 中分類流通量   | 391糸及び紡績半製品                       | S10a\_084 |
| 港湾間流通量 | 中分類流通量   | 401その他繊維工業品                       | S10a\_085 |
| 港湾間流通量 | 中分類流通量   | 411砂糖                                   | S10a\_086 |
| 港湾間流通量 | 中分類流通量   | 421製造食品                               | S10a\_087 |
| 港湾間流通量 | 中分類流通量   | 422飲料                                   | S10a\_088 |
| 港湾間流通量 | 中分類流通量   | 423水                                     | S10a\_089 |
| 港湾間流通量 | 中分類流通量   | 424たばこ                                 | S10a\_090 |
| 港湾間流通量 | 中分類流通量   | 425その他食料工業品                       | S10a\_091 |
| 港湾間流通量 | 中分類流通量   | 431がん具                                 | S10a\_092 |
| 港湾間流通量 | 中分類流通量   | 441衣服・身廻品・はきもの                 | S10a\_093 |
| 港湾間流通量 | 中分類流通量   | 442文房具・運動娯楽用品・楽器             | S10a\_094 |
| 港湾間流通量 | 中分類流通量   | 443家具装備品                             | S10a\_095 |
| 港湾間流通量 | 中分類流通量   | 444その他日用品                           | S10a\_096 |
| 港湾間流通量 | 中分類流通量   | 451ゴム製品                               | S10a\_097 |
| 港湾間流通量 | 中分類流通量   | 461木製品（他に分類されないもの）         | S10a\_098 |
| 港湾間流通量 | 中分類流通量   | 471その他製造工業品                       | S10a\_099 |
| 港湾間流通量 | 中分類流通量   | 481金属くず                               | S10a\_100 |
| 港湾間流通量 | 中分類流通量   | 491再利用資材                             | S10a\_101 |
| 港湾間流通量 | 中分類流通量   | 501動植物性製造飼肥料                     | S10a\_102 |
| 港湾間流通量 | 中分類流通量   | 511廃棄物                                 | S10a\_103 |
| 港湾間流通量 | 中分類流通量   | 512廃土砂                                 | S10a\_104 |
| 港湾間流通量 | 中分類流通量   | 521輸送用容器                             | S10a\_105 |
| 港湾間流通量 | 中分類流通量   | 531取合せ品                               | S10a\_106 |
| 港湾間流通量 | 中分類流通量   | 541分類不能のもの（中分類）               | S10a\_107 |
| 海上経路     | 出発港         | 都道府県                                  | S10a\_108 |
| 海上経路     | 出発港         | 港湾名                                    | S10a\_109 |
| 海上経路     | 寄港地         | 都道府県                                  | S10a\_110 |
| 海上経路     | 寄港地         | 港湾名                                    | S10a\_111 |
| 海上経路     | 到着港         | 都道府県                                  | S10a\_112 |
| 海上経路     | 到着港         | 港湾名                                    | S10a\_113 |
| 海上経路     | 船種           |                                           | S10a\_114 |
| 海上経路     | 航行距離       |                                           | S10a\_115 |
| 海上経路     | 総トン         |                                           | S10a\_116 |
| 海上経路     | 積載可能貨物量 | トラック                                  | S10a\_117 |
| 海上経路     | 積載可能貨物量 | シャーシ                                  | S10a\_118 |
| 海上経路     | 積載可能貨物量 | トレーラー                                | S10a\_119 |
| 海上経路     | 積載可能貨物量 | 中型車                                    | S10a\_120 |
| 海上経路     | 積載可能貨物量 | 乗用車                                    | S10a\_121 |
| 海上経路     | 積載可能貨物量 | コンテナ                                  | S10a\_122 |
| 海上経路     | 積載可能貨物量 | その他                                    | S10a\_123 |
| 海上経路     | 積載可能貨物量 | 化成品                                    | S10a\_124 |
| 海上経路     | 運搬可能旅客数 |                                           | S10a\_125 |
| 海上経路     | 頻度           |                                           | S10a\_126 |

他のとフォーマットを合わせて書き込む

``` r
colnames(tables[[1]]) <- c("_", "name1", "name2", "code")

tables[[1]] %>% 
  transmute(
    name = if_else(name2 != "", paste0(name1, "_", name2), name1),
    code,
    description = NA,
    type = NA
  ) %>% 
  readr::write_csv(output)
```
